// CommCmdParaEditDlg.cpp : 实现文件
//

#include "stdafx.h"
#include "AutoTest.h"
#include "CommCmdParaEditDlg.h"


//////////////////////////////////////////////////////////////////////////

// CCommCmdEditGrid

CCommCmdEditGrid::CCommCmdEditGrid()
{
	
}

CCommCmdEditGrid::~CCommCmdEditGrid()
{
}

BOOL CCommCmdEditGrid::EndEditCell(int nRow, int nCol, DWORD dwItemData/*=0*/)
{
	if (nCol == 3)
	{
		return EndEditCell_Value(nRow, dwItemData);
	}

	return TRUE;
}

BOOL CCommCmdEditGrid::EndEditCell_Value(int nRow, DWORD dwItemData/*=0*/)
{
	CGridCell *pCell = GetCell(nRow, 3);
	CExBaseObject* pObj = (CExBaseObject*)pCell->lParam;

	ASSERT(pObj != NULL);
	if (pObj != NULL)
	{
		if (pObj->GetClassID() == DTMCLASSID_CVALUE)
		{
			CValue *pValue = (CValue *)pObj;
			pValue->m_strValue = pCell->szText;

			if (!IsStringNumber(pValue->m_strValue))
			{
				CCommCmd *pCommCmd = (CCommCmd*)pValue->GetParent()->GetParent();
				ASSERT (pCommCmd->GetClassID() == GBCLASSID_COMMCMD);
				CString strValue = pCommCmd->CalValue(pValue);
				CLogPrint::LogFormatString(LOGLEVEL_TRACE, _T("%s ==>> %s"), pValue->m_strValue, strValue);
			}

			return TRUE;
		}
	}

	return FALSE;
}

// CCommCmdEditGrid 消息处理程序

void CCommCmdEditGrid::ShowColumnTitle()
{	
	SetRowCount(1);
	SetFixedRowCount(1);

	int iNum = 4;
	//char cTempStr[4][24] = {"编号","名称","标识","数值"};
	CString cTempStr[5]={
		CXLanguageResourceAtsBase::g_sLangTxt_Index/*"编号"*/
		,CXLanguageResourceAtsBase::g_sLangTxt_Name/*"名称"*/
		,CXLanguageResourceAtsBase::g_sLangTxt_Id/*"ID"*/
		,CXLanguageResourceAtsBase::g_sLangTxt_Value/*"数值"*/
	};

	int  iColType[4] = {GVET_NOEDIT,GVET_NOEDIT,GVET_NOEDIT};
	int iWidth[4] = {50,250,160, 80};
	GV_ITEM Item;
	Item.mask = GVIF_FORMAT|GVIF_TEXT;
	Item.row = 0;
	Item.nFormat = DT_CENTER|DT_VCENTER|DT_SINGLELINE|DT_END_ELLIPSIS;

	for (int iCol=0;iCol<iNum;iCol++)
	{
		Item.col = iCol+0;
		SetColumnType(iCol,iColType[iCol]);
		SetColumnWidth(iCol,iWidth[iCol]);
		Item.szText=cTempStr[iCol];
		Item.lParam=iCol;
		SetItem(&Item);
	}	

	SetRowHeight(0, 20);
}

void CCommCmdEditGrid::InitGrid(CCommCmd* pCommCmd)
{
	m_pCommCmd = pCommCmd;
	SetListMode(TRUE);
	SetColumnCount(4);
	ShowColumnTitle();
	InitData();
}

void CCommCmdEditGrid::InitData()
{
	CValue *pValue = NULL;
	CValues *pValues = m_pCommCmd->GetCmd()->GetValues();
	long nCount = pValues->GetCount();
	CCmd *pCmd = m_pCommCmd->GetCmd();

	m_pCpuDataList = m_pCommCmd->GetDataset(pCmd->m_nUseDeviceEx);
	SetRowCount(nCount+1);
	int nRow = 1;
	POS pos = pValues->GetHeadPosition();

	while (pos != NULL)
	{
		pValue = (CValue *)pValues->GetNext(pos);
		InsertValuetoItem(pValue, nRow);
		nRow++;
	}
}

void CCommCmdEditGrid::InsertValuetoItem(CExBaseObject *pData,int &nRowIndex)
{
	UINT nClassID = pData->GetClassID();
	ASSERT(nClassID == DTMCLASSID_CVALUE);

	if(nClassID != DTMCLASSID_CVALUE)
	{
		return;
	}

	CValue* pValue = (CValue*)pData;

	GV_ITEM Item;
	Item.mask=GVIF_FORMAT|GVIF_PARAM|GVIF_TEXT  | GVIF_DATATYPE |GVIF_VALUE|GVIS_FOCUSED;	
	Item.nFormat = DT_LEFT|DT_VCENTER|DT_SINGLELINE|DT_END_ELLIPSIS;
	Item.nDataType = 0;
	Item.dwValue = 0;
	Item.row = nRowIndex;

	Item.col = 0;
	Item.lParam = (LPARAM)pData;
	Item.nDataType = GVET_NOEDIT;
	Item.szText.Format(_T("%d"),nRowIndex);
	SetItem(&Item);

	Item.col = 1;
	Item.szText = pValue->m_strID;

	if (m_pCpuDataList != NULL)
	{
		CExBaseObject *pFind = m_pCpuDataList->FindByID(pValue->m_strID);

		if (pFind != NULL)
		{
			Item.szText = pFind->m_strName;
		}
		else
		{
			CDataObj *pDataObj = m_pCommCmd->FindDataObj(pValue->m_strID, m_pCommCmd->GetCpusIndex());

			if (pDataObj != NULL)
			{
				Item.szText = pDataObj->m_strName;
			}
			else
			{
				Item.crFgClr = RGB(255, 0, 0);
			}
		}
	}

	SetItem(&Item);

	Item.col = 2;
	Item.szText = pValue->m_strID;
	SetItem(&Item);

	Item.col = 3;
	Item.nDataType = GVET_EDITBOX;

	Item.szText = pValue->m_strValue;
	SetItem(&Item);

	SetRowHeight(nRowIndex, 20);
}



// CCommCmdParaEditDlg 对话框

CCommCmdParaEditDlg::CCommCmdParaEditDlg(CWnd* pParent /*=NULL*/)
	: CDynDialogEx(pParent, TRUE)
{
	m_pCommCmd = NULL;
}

CCommCmdParaEditDlg::~CCommCmdParaEditDlg()
{
}

void CCommCmdParaEditDlg::DoDataExchange(CDataExchange* pDX)
{
	CDynDialogEx::DoDataExchange(pDX);
	DDX_Control(pDX, IDOK, m_btnCommcmdOk);
	DDX_Control(pDX, IDCANCEL, m_btnCommcmdCancel);
}

void CCommCmdParaEditDlg::xlang_InitAndAdjust()
{
	if (xlang_IsCurrXLanguageChinese())
	{
		return;
	}

	m_btnCommcmdOk.SetLanguageID(CXLanguageResourceAts_AutoTest::g_sLangID_OK);
	m_btnCommcmdCancel.SetLanguageID(CXLanguageResourceAts_AutoTest::g_sLangID_Cancel);


	CXLangWndAdjMngr oWndAdjMngr;         
	oWndAdjMngr.RegisterCols();  
	oWndAdjMngr.RegisterXCol(&m_btnCommcmdOk);  
	oWndAdjMngr.RegisterXCol(&m_btnCommcmdCancel); 


	oWndAdjMngr.Adjust(this, TRUE);
	xlang_InitByLgugStr(CXLanguageResourceAts_AutoTest::g_sLangID_TestItemParEdit, this);
}


BEGIN_MESSAGE_MAP(CCommCmdParaEditDlg, CDynDialogEx)
END_MESSAGE_MAP()


// CCommCmdParaEditDlg 消息处理程序

BOOL CCommCmdParaEditDlg::OnInitDialog()
{
	CDynDialogEx::OnInitDialog();

	CRect rc;
	m_frmGrid.GetWindowRect(&rc);
	ScreenToClient(&rc);

	m_gridPara.Create(rc,this,6001);
	m_gridPara.InitGrid(m_pCommCmd);

    xlang_InitAndAdjust();

	return TRUE;  // return TRUE unless you set the focus to a control
	// 异常: OCX 属性页应返回 FALSE
}
