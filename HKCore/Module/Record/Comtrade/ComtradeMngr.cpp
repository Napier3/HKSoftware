// ComtradeMngr.cpp: implementation of the CComtradeMngr class.
//
//////////////////////////////////////////////////////////////////////

#include "stdafx.h"
#include "ComtradeMngr.h"
#include <math.h>
#ifdef _DEBUG
#undef THIS_FILE
static char THIS_FILE[]=__FILE__;
#define new DEBUG_NEW
#endif

#include "../../MemBuffer/BufferBase.h"
#include "../../API/FileApi.h"
#include "../../GpsPcTime/GpsPcTime.h"
#include "ComtradeRateData.h"
#include "../../API/MathApi.h"

#ifdef _PSX_IDE_QT_ 
#include <QDebug>
#endif
//////////////////////////////////////////////////////////////////////
// Construction/Destruction
//////////////////////////////////////////////////////////////////////

const char* CRcdComtradeFile::g_pszKeyBinary	   = "BINARY";
const char* CRcdComtradeFile::g_pszKeyASCII	   = "ASCII";
const char* CRcdComtradeFile::g_pszKeyCfg		   = "CFG";
const char* CRcdComtradeFile::g_pszKeyDat		   = "DAT";


CRcdComtradeFile::CRcdComtradeFile(BOOL bCreateBuffer)
{
	m_nBufBeginPos1	= -1;
	m_nBufBeginPos2	= -1;
	m_nBufLength1	= -1;
	m_nBufLength2	= -1;

	m_strBasicInfo   = "RecordTest,1,1999";
	m_pdSamRate		 = NULL;
	m_pnDataPoints	 = NULL;

	m_nSamAmount	 = 1;
	m_dFreq			 = 50.0;
	m_dTimeCoef		 = 1;
	m_nDataFileType	 = COMTRADE_DATAFILE_TYPE_BINARY;

	m_nComtradeVersion = 1999;

	m_nAllChs = 0;
	m_nAnalogs	= 0;
	m_nBinarys	= 0;
	memset(&m_oFirstPointTime,0,sizeof(RTTIME));
	memset(&m_oTrigPointTime,0,sizeof(RTTIME));

	m_strStationName	= "PONOCO";
	m_strRecordingDeviceID		= _T("Devcie");

	m_nSaveGap = 1;
	m_nBufferLen = 0;
	m_bCreateBuffer = bCreateBuffer;
	m_nTotalPoints = 0;

	//2021-1-17  lijunqing
	m_nRefCount = 0;
}

CRcdComtradeFile::~CRcdComtradeFile()
{
	BufferClear();

	m_listAnalog.RemoveAll();
	m_listBinary.RemoveAll();
	m_listRates.RemoveAll();

}

void CRcdComtradeFile::AddRef()
{
	m_nRefCount++;
}

void CRcdComtradeFile::Release()
{
	if (m_nRefCount == 0)
	{
		return;
	}

	m_nRefCount--;
}

long CRcdComtradeFile::GetUCount()
{
	return GetChCount(_T("V")) + GetChCount(_T("v")) ;
}

long CRcdComtradeFile::GetICount()
{
	return GetChCount(_T("A")) + GetChCount(_T("a")) ;
}

long CRcdComtradeFile::GetChCount(const CString &strUnit)
{
	POS pos = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *p = NULL;
	long nCount = 0;

	while (pos != NULL)
	{
		p = (CComtradeAnalogData *)m_listAnalog.GetNext(pos);

		if (p->m_strUnit == strUnit)
		{
			nCount++;
		}
	}

	return nCount;
}

// CComtradeAnalogData* CRcdComtradeFile::GetAnalogData(long nCh_Index, const CString &strUnit)
// {
// 	if (nCh_Index<=0)
// 	{
// 		return NULL;
// 	}
// 
// 	POS pos = m_listAnalog.GetHeadPosition();
// 	CComtradeAnalogData *p = NULL;
// 	long nCurIndex = 1;
// 
// 	while (pos != NULL)
// 	{
// 		p = (CComtradeAnalogData *)m_listAnalog.GetNext(pos);
// 
// 		if (p->m_strUnit == strUnit)
// 		{
// 			if (nCurIndex == nCh_Index)
// 			{
// 				return p;
// 			}
// 			else if (nCurIndex>nCh_Index)
// 			{
// 				break;
// 			}
// 
// 			nCurIndex++;
// 		}
// 	}
// 
// 	return NULL;
// }

CComtradeAnalogData* CRcdComtradeFile::GetAnalogDataByChIndex(long nCh_Index,BOOL bTypeU)
{
	POS pos = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pCurObj = NULL;
	CComtradeAnalogData *pAnalogChFind = NULL;

	while(pos)
	{
		pCurObj = (CComtradeAnalogData*)m_listAnalog.GetNext(pos);

		if (pCurObj->IsAnalogUData() != bTypeU)
		{
			continue;
		}

		if (((CComtradeAnalogData *)pCurObj)->m_nChannelIndex == nCh_Index)
		{
			pAnalogChFind = pCurObj;
			break;
		}
	}

	return pAnalogChFind;
}

CComtradeAnalogData* CRcdComtradeFile::GetAnalogDataByChIndex(long nCh_Index)
{
	POS pos = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pCurObj = NULL;
	CComtradeAnalogData *pAnalogChFind = NULL;

	while(pos)
	{
		pCurObj = (CComtradeAnalogData*)m_listAnalog.GetNext(pos);

		if (((CComtradeAnalogData *)pCurObj)->m_nChannelIndex == nCh_Index)
		{
			pAnalogChFind = pCurObj;
			break;
		}
	}

	return pAnalogChFind;
}

CComtradeAnalogData* CRcdComtradeFile::GetAnalogDataByIndex(long nIndex)
{
	return (CComtradeAnalogData*)m_listAnalog.GetAtIndex(nIndex);
}

CComtradeAnalogData* CRcdComtradeFile::FindAnalogDataByChID(const CString &strID)
{
	POS pos = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pCurObj = NULL;
	CComtradeAnalogData *pAnalogChFind = NULL;

	while(pos)
	{
		pCurObj = (CComtradeAnalogData*)m_listAnalog.GetNext(pos);

		if (pCurObj->m_strID == strID)
		{
			pAnalogChFind = pCurObj;
			break;
		}
	}

	return pAnalogChFind;
}

CComtradeAnalogData* CRcdComtradeFile::FindAnalogDataByChType(const CString &strChType, long nIndex)
{
	CExBaseList listTemp;
	POS pos = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pCurObj = NULL;
	CComtradeAnalogData *pAnalogChFind = NULL;

	while(pos)
	{
		pCurObj = (CComtradeAnalogData*)m_listAnalog.GetNext(pos);

		if (pCurObj->MatchType(strChType))
		{
			listTemp.AddTail(pCurObj);
		}
	}

	if (nIndex < 0)
	{
		nIndex = 0;
	}

	pAnalogChFind = (CComtradeAnalogData *)listTemp.GetAtIndex(nIndex);
	listTemp.RemoveAll();

	return pAnalogChFind;
}

long CRcdComtradeFile::GetUOrder()
{
	return GetChOrder(_T("V"));
}

long CRcdComtradeFile::GetIOrder()
{
	return GetChOrder(_T("A"));
}

long CRcdComtradeFile::GetChOrder(const CString &strUnit)
{
	long nCount = m_listAnalog.GetCount();

	if (nCount == 0)
	{
		return -1;
	}

	long nIndex = 0;
	POS pos = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *p = NULL;
	long nFirstOrder = 0;
	BYTE *pBuffer = new BYTE [nCount];
	ZeroMemory(pBuffer, nCount);
	long nBeginPos = 0;

	while (pos != NULL)
	{
		p = (CComtradeAnalogData *)m_listAnalog.GetNext(pos);

		if (p->m_strUnit == strUnit)
		{
			pBuffer[nIndex] = 1;
		}

		nIndex++;
	}

	while (nBeginPos < nCount)
	{
		for (; nBeginPos<nCount; nBeginPos++)
		{
			if (pBuffer[nBeginPos] == 1)
			{
				nFirstOrder += nBeginPos;
				break;
			}
		}

		for (nIndex=nBeginPos+1; nIndex<nCount; nIndex++)
		{
			if (pBuffer[nIndex] != pBuffer[nIndex-1])
			{
				break;
			}
		}

		nBeginPos = nIndex;
	}

	delete []pBuffer;

	return nFirstOrder;
}



void CRcdComtradeFile::Init()
{
	DeleteAll();
	m_listAnalog.RemoveAll();
	m_listBinary.RemoveAll();
	m_listRates.RemoveAll();

	m_nBufBeginPos1	= -1;
	m_nBufBeginPos2	= -1;
	m_nBufLength1	= -1;
	m_nBufLength2	= -1;

	if (m_pdSamRate != NULL)
	{
		delete []m_pdSamRate;
		m_pdSamRate = NULL;
	}

	if (m_pnDataPoints != NULL)
	{
		delete []m_pnDataPoints;
		m_pnDataPoints = NULL;
	}

	m_nAnalogs	= 0;
	m_nBinarys	= 0;
	memset(&m_oFirstPointTime,0,sizeof(RTTIME));
	memset(&m_oTrigPointTime,0,sizeof(RTTIME));
}

//ÉèÖÃComtradeÐÅÏ¢
void CRcdComtradeFile::BufferClear()
{
	Init();
}

void CRcdComtradeFile::ClearDataBuffer()
{
	POS pos = GetHeadPosition();
	CComtradeDataBase* pObj = NULL;
	long nIndex = -1;

	while (pos != NULL)
	{
		pObj = (CComtradeDataBase*)GetNext(pos);

		if (pObj->IsAnalogData())
		{
			pObj->ClearBuffer();
		}
		else
		{
			if (pObj->GetClassID()==GLOBALCLASSID_CCOMTRADERATEDATA)
			{
				continue;
			}
			CComtradeBinaryData* pBinary = (CComtradeBinaryData*)pObj;
			long nWordIndex = pBinary->m_nDataIndex / 16;

			if (nWordIndex != nIndex)
			{
				nIndex = nWordIndex;
				pBinary->ClearBuffer();
			}	
		}
	}
}

void CRcdComtradeFile::ResetDataBuffer()
{
	POS pos = GetHeadPosition();
	CComtradeDataBase* pObj = NULL;
	long nIndex = -1;

	while (pos != NULL)
	{
		pObj = (CComtradeDataBase*)GetNext(pos);

		if (pObj->IsAnalogData())
		{
			pObj->GetMemBuffer_UShort()->Init();
		}
		else
		{
			if (pObj->GetClassID()==GLOBALCLASSID_CCOMTRADERATEDATA)
			{
				continue;
			}

			CComtradeBinaryData* pBinary = (CComtradeBinaryData*)pObj;
			long nWordIndex = pBinary->m_nDataIndex / 16;

			if (nWordIndex != nIndex)
			{
				nIndex = nWordIndex;
				pBinary->GetMemBuffer_UShort()->Init();
			}	
		}
	}
}

void CRcdComtradeFile::UpdateSmpRatesList()
{
	m_listRates.RemoveAll();
	POS pos = GetHeadPosition();
	CExBaseObject *pCurObj = NULL;

	while(pos)
	{
		pCurObj = GetNext(pos);

		if (pCurObj->GetClassID() == GLOBALCLASSID_CCOMTRADERATEDATA)
		{
			Delete(pCurObj);
		}
	}

	CComtradeRateData *pNew = NULL;

	for (int nSamIndex = 0;nSamIndex<m_nSamAmount;nSamIndex++)
	{
		pNew = new CComtradeRateData();
		pNew->m_nSamprate = m_pdSamRate[nSamIndex];
		pNew->m_nEndsamp = m_pnDataPoints[nSamIndex];
		AddNewChild(pNew);
		m_listRates.AddTail(pNew);
	}
}

void CRcdComtradeFile::GetChannelAmount()
{
	POS pos = GetHeadPosition();
	m_nAnalogs	= 0;
	m_nBinarys	= 0;
	m_nAllChs = 0;
	CComtradeDataBase* pObj = NULL;

	while (pos != NULL)
	{
		pObj = (CComtradeDataBase*)GetNext(pos);
		if (pObj == NULL)
		{
			break;
		}
		if (pObj->IsAnalogData())
		{
			m_nAnalogs++;
		}
		else
		{
			if (pObj->GetClassID()==GLOBALCLASSID_CCOMTRADERATEDATA)
			{
				continue;
			}
			m_nBinarys++;
		}
		m_nAllChs++;
	}
}

void CRcdComtradeFile::CalMinMaxValue()
{
	CComtradeDataBase *p = NULL;
	POS pos = GetHeadPosition();

	while (pos != NULL)
	{
		p = (CComtradeDataBase *)GetNext(pos);

		if (p->IsAnalogData())
		{
			((CComtradeAnalogData*)p)->CalMinMaxValue(m_nTotalPoints);
		}
	}
}

void CRcdComtradeFile::UpdateCoef_SpecialSmpRate()
{
	if (m_nDataFileType != COMTRADE_DATAFILE_TYPE_BINARY)
	{
		return;
	}

	CComtradeDataBase *p = NULL;
	double dCurFreq = m_dFreq;
	POS pos = GetHeadPosition();

	while (pos != NULL)
	{
		p = (CComtradeDataBase *)GetNext(pos);

		if (p->IsAnalogData())
		{
			long nPtBeginIndex = 0;
			double dMaxValue = 0.0f, dMinValue = 0.0f;

			for (int nIndex = 0; nIndex < m_nSamAmount; nIndex++)
			{
				if ((fabs(dCurFreq * 2 - m_pdSamRate[nIndex]) < 0.0001) || (fabs(dCurFreq - m_pdSamRate[nIndex]) < 0.0001))
				{
					((CComtradeAnalogData*)p)->GetMaxMinValue(nPtBeginIndex, m_pnDataPoints[nIndex],  dMaxValue, dMinValue);
				}

				nPtBeginIndex += m_pnDataPoints[nIndex];
			}

			if (fabs(dMaxValue) < fabs(dMinValue))
			{
				dMaxValue = fabs(dMinValue);
			}

			((CComtradeAnalogData*)p)->UpdateCoef_SpecialSmpRate(dMaxValue);
		}
	}
}

void CRcdComtradeFile::ResetCoefZeroValue()
{
	CComtradeDataBase *p = NULL;
	POS pos = GetHeadPosition();
	CComtradeAnalogData *pComtradeAnalogData = NULL;

	while (pos != NULL)
	{
		p = (CComtradeDataBase *)GetNext(pos);

		if (p->IsAnalogData())
		{
			pComtradeAnalogData = (CComtradeAnalogData *)p;
			pComtradeAnalogData->m_dCoefValue = pComtradeAnalogData->m_dCoefValueBK;
			pComtradeAnalogData->m_dZeroValue = pComtradeAnalogData->m_dZeroValueBK;
		}
	}
}

//strFilePathÊÇÎÄ¼þÂ·¾¶£¬²»°üÀ¨ºó×ºÃû
void CRcdComtradeFile::SaveComtradeFile(const CString& strFilePath)
{
	if (m_nBufLength1 < 1)
	{
		return;
	}


	switch(m_nComtradeVersion)
	{
	case 1991:
		break;
	case 1999:
		{
			SaveCFGFile(strFilePath);

			if (m_nDataFileType == COMTRADE_DATAFILE_TYPE_ASCII)
			{
				SaveDataAsASIIMode(strFilePath);
			}
			else
			{
				SaveDataAsBINARYMode(strFilePath);
			}
			SaveMrttFile(strFilePath);
		}
		break;
	}
}

void CRcdComtradeFile::SaveDatFile(const CString& strFilePath)
{
	if (m_nBufLength1 < 1)
	{
		return;
	}

	if (m_nDataFileType == COMTRADE_DATAFILE_TYPE_ASCII)
	{
		SaveAsciiDatDataFile(strFilePath);
	}
	else
	{
		SaveBinaryDatDataFile(strFilePath);
	}
}

void CRcdComtradeFile::SaveMrttFile(const CString& strFilePath)
{
	// 	CMR1200BaseApp *//pApp = (CMR1200BaseApp *)AfxGetApp();
	// 	//g_theRecordApp.WriteMrttFile(strFilePath);
}

void CRcdComtradeFile::SaveCFGFile(const CString& strFilePath)
{
	FILE* pFile = NULL;
	CString strCFGFilePath;
	//strCFGFilePath.Format(_T("%s.%s"),strFilePath,g_pszKeyCfg);
	strCFGFilePath = strFilePath;

	CString strTempKey = CString(g_pszKeyCfg);
	strCFGFilePath = ChangeFilePostfix(strCFGFilePath, strTempKey);
	CString strTemp;
	char pszCFGFilePath[MAX_PATH*2];
	CString_to_char(strCFGFilePath, pszCFGFilePath);
	pFile = fopen(pszCFGFilePath,"w");
	long nIndex = 0;
	//Edit by lipenghui 2020-04-15
	m_strBasicInfo.Format(_T("%s,%s,%d"),m_strStationName.GetString(),m_strRecordingDeviceID.GetString(),m_nComtradeVersion);

	// 	long nLen = m_nBufLength1;
	// 
	// 	if (m_nBufLength2 > 0)
	// 	{
	// 		nLen += m_nBufLength2;
	// 	}
	// 
	// 	m_pnDataPoints[0] = nLen / m_nSaveGap;

	if (pFile != NULL)
	{
		fprintf(pFile,"%s\n",m_strBasicInfo.GetString());//Õ¾ÃûµÈÐÅÏ¢
		GetChannelAmount();

		if (m_oTrigPointTime.wDay == 0 || m_oTrigPointTime.wMonth ==0)
		{
			CTime oTime = CTime::GetCurrentTime();
			m_oTrigPointTime.wYear	 = oTime.GetYear();
			m_oTrigPointTime.wMonth  = oTime.GetMonth();
			m_oTrigPointTime.wDay    = oTime.GetDay();
			m_oTrigPointTime.wHour   = oTime.GetHour();
			m_oTrigPointTime.wMinute = oTime.GetMinute();
			m_oTrigPointTime.wSecond = oTime.GetSecond();
			m_oTrigPointTime.wMicroseconds = 0;
			m_oTrigPointTime.wMilliseconds = 0;

			m_oFirstPointTime.wYear	 = oTime.GetYear();
			m_oFirstPointTime.wMonth  = oTime.GetMonth();
			m_oFirstPointTime.wDay    = oTime.GetDay();
			m_oFirstPointTime.wHour   = oTime.GetHour();
			m_oFirstPointTime.wMinute = oTime.GetMinute();
			m_oFirstPointTime.wSecond = oTime.GetSecond();
			m_oFirstPointTime.wMicroseconds = 0;
			m_oFirstPointTime.wMilliseconds = 0;
		}

		fprintf(pFile,"%d,%dA,%dD\n",m_nBinarys + m_nAnalogs, m_nAnalogs, m_nBinarys);//Í¨µÀÊýÁ¿
		//¸÷¸öÍ¨µÀµÄÐÅÏ¢
		POS pos = GetHeadPosition();
		CComtradeDataBase* pObj = NULL;

		while (pos != NULL)
		{
			pObj = (CComtradeDataBase*)GetNext(pos);

			if (pObj->GetClassID() == GLOBALCLASSID_CCOMTRADERATEDATA)
			{
				continue;
			}

			pObj->SaveChanInfo(strTemp);
			fprintf(pFile,"%s\n",strTemp.GetString());
		}

		fprintf(pFile,"%.3f\n",m_dFreq);//µçÍøÆµÂÊ

		//²ÉÑùÂÊÐÅÏ¢
		fprintf(pFile,"%d\n",m_nSamAmount);//²ÉÑùÂÊÊýÁ¿

		for(nIndex = 0; nIndex < m_nSamAmount ; nIndex++)
		{
			fprintf(pFile,"%.3f,%d\n",(m_pdSamRate[nIndex] / m_nSaveGap), m_pnDataPoints[nIndex]);//²ÉÑùÂÊÊýÁ¿
		}
		//µÚÒ»¸öµãµÄÊ±¼ä
		double dSec = m_oFirstPointTime.wSecond + m_oFirstPointTime.wMilliseconds / 1000.0 + m_oFirstPointTime.wMicroseconds / 1000000.0;
		strTemp.Format(_T("%02d/%02d/%d,%02d:%02d:%.6f"),m_oFirstPointTime.wDay,m_oFirstPointTime.wMonth,
			m_oFirstPointTime.wYear,m_oFirstPointTime.wHour,m_oFirstPointTime.wMinute,dSec);
		fprintf(pFile,"%s\n",strTemp.GetString());
		//´¥·¢µãÊ±¼ä
		dSec = m_oTrigPointTime.wSecond + m_oTrigPointTime.wMilliseconds / 1000.0 + m_oTrigPointTime.wMicroseconds / 1000000.0;
		strTemp.Format(_T("%02d/%02d/%d,%02d:%02d:%.6f"),m_oTrigPointTime.wDay,m_oTrigPointTime.wMonth,
			m_oTrigPointTime.wYear,m_oTrigPointTime.wHour,m_oTrigPointTime.wMinute,dSec);
		fprintf(pFile,"%s\n",strTemp.GetString());

		//ÎÄ¼þ¸ñÊ½
		if (m_nDataFileType == COMTRADE_DATAFILE_TYPE_ASCII)
		{
			fprintf(pFile,"%s\n",g_pszKeyASCII);
		}
		else
		{
			fprintf(pFile,"%s\n",g_pszKeyBinary);
		}

		fprintf(pFile,"%.3f\n",m_dTimeCoef);
		///////
		fclose(pFile);
		pFile = NULL;
	}

	m_nSaveGap = 1;//Ê¹²ÉÑùÂÊ±ä³ÉÊµ¼Ê²ÉÑùÂÊ
	m_oTrigPointTime.wMonth = 0;
}

void CRcdComtradeFile::SaveDataAsBINARYMode(const CString& strFilePath)
{
	//	CMR1200BaseApp *//pApp = (CMR1200BaseApp*)AfxGetApp();
	long nIndex = 0;
	//	long nTotalPoints = 0;

	// 	if (m_nBufLength1 > 0)
	// 	{
	// 		nTotalPoints += m_nBufLength1;
	// 	}
	// 
	// 	if (m_nBufLength2 > 0)
	// 	{
	// 		nTotalPoints += m_nBufLength2;
	// 	}

	long nSteps = 20;
	long nStepPoints = m_nTotalPoints / nSteps;
	long nStep = 0;

	if (nStepPoints > 65536)
	{
		nStepPoints = 65536;
		nStepPoints = m_nTotalPoints / nSteps;
		nSteps = m_nTotalPoints / nStepPoints + 1;
	}

	if (nStepPoints * nSteps < m_nTotalPoints)
	{
		nSteps++;
	}

	long nStepIndex = 0;

	FILE* pFile = NULL;
	CString strDatFilePath;
	//strDatFilePath.Format(_T("%s.%s"),strFilePath,g_pszKeyDat);
	strDatFilePath = strFilePath;

	CString strTempKey = CString(g_pszKeyDat);
	strDatFilePath = ChangeFilePostfix(strFilePath, strTempKey);

	CString strTemp;
	char pszDatFilePath[MAX_PATH];
	CString_to_char(strDatFilePath, pszDatFilePath);
	pFile = fopen(pszDatFilePath,"wb");
	unsigned short unCurrentData = 0;
	CComtradeDataBase* pObj = NULL;
	POS pos = NULL;
	long nBinaryIndex = 0;//¿ª¹ØÍ¨µÀË÷Òý
	WORD wBinaryValue = 0;

	//	//g_theRecordApp.FireSysOptrMsg(MR1200_SYSOPTR_SAVE_RECORDFILE, 0, MAKELONG(nStep, nSteps));

	if (pFile == NULL)
		return;

	DWORD dwIndex = 1;
	DWORD dwmTimestamp = 0xFFFFFFFF; //²»¼ÆËãÊ±±êÁË£¬ÒòÎª²ÉÑùÂÊºÍ¸÷¸ö²ÉÑùÂÊÏÂµÄµãÊý¶¼ÓÐ
	nIndex = 0;
	unsigned short unCurBinaryData = 0;//zhouhj ÒòÎªÖ»ÓÐµÚÒ»¸ö¿ª¹ØÁ¿Í¨µÀ¼ÇÂ¼ÁËÍêÕûµÄÁ¬Ðø16¸öÍ¨µÀµÄ×´Ì¬Öµ£¬Ðè½«Æä¼ÇÂ¼

	/////// ±£´æÊý¾Ý	
	//		if (m_nBufLength1 > 0)
	for(nIndex = 0 ; nIndex < m_nTotalPoints; nIndex += m_nSaveGap)
	{
		dwmTimestamp = GetCurPointTimeStamp(nIndex);
		fwrite(&dwIndex,4,1,pFile);
		fwrite(&dwmTimestamp,4,1,pFile);
		nBinaryIndex = 0;
		wBinaryValue = 0;
		unCurBinaryData = 0;
		pos = GetHeadPosition();

		while (pos != NULL)
		{
			pObj = (CComtradeDataBase*)GetNext(pos);

			if (pObj->GetClassID()==GLOBALCLASSID_CCOMTRADERATEDATA)
			{
				continue;
			}

			unsigned short* pBuffer = pObj->GetBuffer() ;

			//ÓÉÓÚ¿ª³öÁ¿Í¨µÀÊÇ¹ÒÔØbuffer£¬ºó¼¸ÌõÍ¨µÀÃ»ÓÐÊµ¼Ê»º´æÇø,µ¼ÖÂÔ½½çÖÐ¶Ï
			if(pObj->m_nTotalPoints <= 0)
			{
				continue;
			}

			unCurrentData = *(pBuffer + m_nBufBeginPos1 + nIndex);

			if (pObj->IsAnalogData())
			{				
				if (unCurrentData == 0x8000)//0x8000 ±£Áô
				{
					unCurrentData = 0x8001;			
				}

				fwrite(&unCurrentData,2,1,pFile);
			}
			else // ÒòÎªÁ´±íÖÐÊÇ°´ÕÕÏÈÄ£Äâºó¿ª¹ØµÄË³Ðò·ÅÖÃ
			{
				if ((nBinaryIndex%16) == 0)
				{
					unCurBinaryData = unCurrentData;
				}
				else
				{
					unCurrentData = unCurBinaryData;
				}

				CComtradeBinaryData* pBinary = (CComtradeBinaryData*)pObj;
				unCurrentData >>= (pBinary->m_nDataIndex);//ÏÈÒÆµ½0Î»
				unCurrentData &= 0x1;//³ýÁË0Î»ÍâÆäËüÎ»±äÎª0
				unCurrentData <<= (nBinaryIndex % 16); //ÒÆ¶¯µ½Òª±£´æµÄÎ»
				wBinaryValue |= unCurrentData;

				if ((nBinaryIndex%16) == 15) //zhouhj 20200912 nBinaryIndexÎª×ÜµÄ¿ª¹ØÁ¿Index
				{
					//							nBinaryIndex = 0;  zhouhj  20200911 ´Ë´¦²»ÄÜÉèÖÃÎª0£¬·ñÔò¿ª¹ØÁ¿È±ÉÙÒ»¸öÍ¨µÀ
					fwrite(&wBinaryValue,2,1,pFile);
					wBinaryValue = 0;
				}
				else
				{
					if (nBinaryIndex == m_nBinarys - 1)//µ½ÁËÍ¨µÀÊý
					{
						fwrite(&wBinaryValue,2,1,pFile);
					}
				}

				nBinaryIndex++;
			}
		}

		nStepIndex++;

		if (nStepIndex >= nStepPoints)
		{
			nStepIndex = 0;
			////g_theRecordApp.FireSysOptrMsg(MR1200_SYSOPTR_SAVE_RECORDFILE, 0, MAKELONG(nStep, nSteps));
			nStep++;
		}

		dwIndex++;
	}
	//////////////////////////

	fclose(pFile);
	pFile = NULL;

	////g_theRecordApp.FireSysOptrMsg(MR1200_SYSOPTR_SAVE_RECORDFILE, 1, MAKELONG(nStep, nSteps));

}

void CRcdComtradeFile::SaveDataAsASIIMode(const CString& strFilePath)
{
}

void CRcdComtradeFile::GetSaveTimeRange(long nBeginPos1,long nLen1,long nBeginPos2,long nLen2)
{
	m_nBufBeginPos1 = nBeginPos1;
	m_nBufBeginPos2 = nBeginPos2;
	m_nBufLength1	= nLen1;
	m_nBufLength2	= nLen2;
}

long CRcdComtradeFile::ReadComtradeFile(const CString& strFilePath, UINT nReadMask)
{
	if ( (nReadMask & CMTRD_RDF_CLEARBUFF) == CMTRD_RDF_CLEARBUFF)
	{
		BufferClear();
	}

	BOOL bReadCfgRet = TRUE;//20220915 zhouhj Ôö¼ÓÓÃÓÚ·ÀÖ¹cfgÎÄ¼þ´ò¿ªÊ§°Ü,»òÕßÑéÖ¤Ê§°Ü,µ¼ÖÂºóÐøÄÚÈÝ½âÎö³ö´í

	if ( (nReadMask & CMTRD_RDF_READCFG) == CMTRD_RDF_READCFG)
	{
		bReadCfgRet = ReadCFGFile(strFilePath);
	}

	if (( (nReadMask & CMTRD_RDF_READDATA) == CMTRD_RDF_READDATA)&&(bReadCfgRet))
	{
		m_strComtradeFile = strFilePath;

		// 		m_listAnalog.RemoveAll();
		// 		m_listBinary.RemoveAll();
		m_nTotalPoints = ReadDataFile(strFilePath);

	}

	if (bReadCfgRet)
	{
		CalMinMaxValue();
	}

	return m_nTotalPoints;
}

void CRcdComtradeFile::ReadCfg_SampRate(char *pString, float &fRampRate, long &nTotalPoints)
{
	//sscanf(pString,"%f,%d", &fRampRate, &nTotalPoints);
	fRampRate = atof(pString);

	char *p = pString;
	char *pEnd = pString + strlen(pString);

	while (*p != ',' && p < pEnd)
	{
		p++;
	}

	if (*p == ',')
	{
		p++;

		while (*p == ' ')
		{
			p++;
		}

		nTotalPoints = atol(p);
	}
	else
	{
		nTotalPoints = 0;
	}
}

void CRcdComtradeFile::SetDataFileTypeByString(char *sString)
{
	if (_stricmp(sString, g_pszKeyASCII) == 0)
	{
		m_nDataFileType = COMTRADE_DATAFILE_TYPE_ASCII;
	}
	else if (_stricmp(sString, g_pszKeyBinary) == 0)
	{
		m_nDataFileType = COMTRADE_DATAFILE_TYPE_BINARY;
	}
}

BOOL CRcdComtradeFile::ReadCFGFile(const CString& strFilePath)
{
	char *sString = NULL;
	CString strCFGFilePath;
	CBufferBase oBuffer;
	CString strTemp = CString(g_pszKeyCfg);
	strCFGFilePath = ChangeFilePostfix(strFilePath, strTemp);

#ifdef _PSX_QT_LINUX_
	if(!IsFileExist(strCFGFilePath))
	{
        strTemp = _T("cfg");
		strCFGFilePath = ChangeFilePostfix(strFilePath, strTemp);			
		if(!IsFileExist(strCFGFilePath.GetString()))
		{
			return FALSE;
		}
	}

#endif
	//strCFGFilePath.Format(_T("%s.%s"),strFilePath,g_pszKeyCfg);

	if (!oBuffer.ReadFromFile(strCFGFilePath))
	{
		return FALSE;
	}

	oBuffer.FormatBuffer('\r');
	oBuffer.FormatBuffer('\n');

	long nIndex = 0;
	m_nBufLength1 = 0;
	CString strParse[PARSE_PART_AMOUNT];//
	long nBinaryIndex = 0;
	//	int nChans = 0;
	long nTotalPoints = 0;
	long nSamIndex = 0;
	unsigned short* pBinaryPreBuffer = NULL;

	while (TRUE) 
	{
		sString = oBuffer.GetString();

		if (!oBuffer.IsPoiterInBuffer(sString))
		{
			break;
		}

		nIndex++;

		if (nIndex == 1) 
		{
			CString strTemp[3];
			ParseString(CString(sString),strTemp);
			m_strStationName = strTemp[0];
			m_strRecordingDeviceID = strTemp[1];
			m_nComtradeVersion = CString_To_long(strTemp[2]);
		}
		else if (nIndex == 2) //µÚ¶þÐÐÊÇÍ¨µÀÊýÁ¿µÄ,¹Ì¶¨ÐÐ
		{
			sscanf(sString,"%d,%dA,%dD",&m_nAllChs,&m_nAnalogs,&m_nBinarys);
		}
		else if (nIndex > 2 && nIndex < m_nAnalogs + 3)
		{
			CComtradeAnalogData *pNew = new CComtradeAnalogData();
			ParseString(CString(sString), strParse);
			pNew->GetChanInfor(strParse);
			//Ìí¼ÓÈëÁ´±í
			AddNewChild(pNew);//zhouhj 20210918 ±ãÓÚÔÚÍ¨µÀÖÐ²éÕÒ,µ±Ç°ÊÇ¶þ½øÖÆ»¹ÊÇASCII¸ñÊ½
			m_listAnalog.AddTail(pNew);
		}
		else if (nIndex > m_nAnalogs + 2 && nIndex < m_nAllChs + 3)
		{
			CComtradeBinaryData* pNew = new CComtradeBinaryData();
			ParseString(CString(sString),strParse);

			if (CString_To_long(strParse[0]) == (nIndex-2))//Ö»ÓÐÔÚ±àºÅÎªÄ£ÄâÁ¿¡¢Êý×ÖÁ¿Á¬Ðø±àºÅÊ±£¬ÐèÒªÈ¥³ýÄ£ÄâÁ¿µÄ±àºÅ£¬·ñÔòÓÃµ±Ç°Êµ¼Ê±àºÅ
			{
				pNew->GetChanInfor(strParse,m_nAnalogs);
			} 
			else
			{
				pNew->GetChanInfor(strParse,0);
			}

			AddNewChild(pNew);
			m_listBinary.AddTail(pNew);
		}
		else if (nIndex == m_nAllChs + 3)//µçÍøÆµÂÊ
		{
			m_dFreq = atof(sString);
		}
		else if (nIndex == m_nAllChs + 4)//²ÉÑùÂÊ¸öÊý
		{
			m_nSamAmount = atoi(sString);

			//Ò»°ãÇé¿öÏÂ,²ÉÑùÂÊÊýÁ¿Ò»¶¨ÎªÕýÊý,ÇÒ²»Ó¦¸Ã³¬¹ý10,Èç¹û³öÏÖ´ËÖµ,ÔòÌáÊ¾ÓÃ»§È·ÈÏ
			if ((m_nSamAmount>30)||(m_nSamAmount<=0))
			{
				CLogPrint::LogFormatString(XLOGLEVEL_ERROR,_T("²ÉÑùÂÊÊýÁ¿Òì³£(m_nSamAmount=%ld),Çë×¢ÒâÈ·ÈÏ.")
					,m_nSamAmount);
			}

			m_pnDataPoints = new long[m_nSamAmount];
			m_pdSamRate    = new float[m_nSamAmount];
		}
		else if (nIndex > m_nAllChs + 4 && nIndex < (m_nAllChs + 5 + m_nSamAmount))
		{
			//´¦Àí²»¹æ·¶µÄ¸ñÊ½£¬ÀýÈç£º25462.914062  ,      5732
			ReadCfg_SampRate(sString, m_pdSamRate[nSamIndex], m_pnDataPoints[nSamIndex]);
			//CString strLeft,strRight;
			//sscanf(sString,"%f,%d", &m_pdSamRate[nSamIndex], &m_pnDataPoints[nSamIndex]);
			// 			nLength = strTemp.GetLength();
			// 			nPos    = strTemp.FindOneOf(_T(","));
			// 			strLeft = strTemp.Left(nPos);
			// 			strRight = strTemp.Right(nLength - nPos - 1);
			// 			m_pnDataPoints[nSamIndex] = CString_To_long(strRight);
			// 			m_pdSamRate[nSamIndex]    = CString_To_double(strLeft);

			CComtradeRateData *pNew = new CComtradeRateData();
			pNew->m_nSamprate = m_pdSamRate[nSamIndex];
			pNew->m_nEndsamp = m_pnDataPoints[nSamIndex];
			AddNewChild(pNew);
			m_listRates.AddTail(pNew);

//			nTotalPoints += m_pnDataPoints[nSamIndex];//zhouhj ÔÚÐ£ÕýÍêµãÊýºó,ÔÙ½øÐÐ×ÜµãÊýÍ³¼Æ
			nSamIndex++;
		}
		else if (nIndex == m_nAllChs + 5 + m_nSamAmount) //µÚÒ»¸öµãÊ±¼ä
		{
			double dSec = 0;
			sscanf(sString,"%hd/%hd/%hd,%hd:%hd:%lf",&(m_oFirstPointTime.wDay),
				&(m_oFirstPointTime.wMonth),&(m_oFirstPointTime.wYear),
				&(m_oFirstPointTime.wHour),&(m_oFirstPointTime.wMinute),&dSec);

			m_strFirstPointTime.Format(_T("%02hd/%02hd/%02hd,%02hd:%02hd:%lf"), (m_oFirstPointTime.wDay),
				(m_oFirstPointTime.wMonth),(m_oFirstPointTime.wYear),
				(m_oFirstPointTime.wHour),(m_oFirstPointTime.wMinute),dSec);

			m_oFirstPointTime.wSecond = (WORD)dSec;

			double dRemain = (dSec - m_oFirstPointTime.wSecond ) * 1000;
			m_oFirstPointTime.wMilliseconds = (WORD)dRemain;

			dRemain = (dRemain - m_oFirstPointTime.wMilliseconds ) * 1000;
			m_oFirstPointTime.wMicroseconds = (WORD)dRemain;
		}
		else if (nIndex == m_nAllChs + 6 + m_nSamAmount) //´¥·¢µãÊ±¼ä
		{
			double dSec = 0;
			sscanf(sString,"%hd/%hd/%hd,%hd:%hd:%lf",&(m_oTrigPointTime.wDay),
				&(m_oTrigPointTime.wMonth),&(m_oTrigPointTime.wYear),
				&(m_oTrigPointTime.wHour),&(m_oTrigPointTime.wMinute),&dSec);
			m_oTrigPointTime.wSecond = (WORD)dSec;

			m_strTrigPointTime.Format(_T("%02hd/%02hd/%02hd,%02hd:%02hd:%lf"), (m_oTrigPointTime.wDay),
				(m_oTrigPointTime.wMonth),(m_oTrigPointTime.wYear),
				(m_oTrigPointTime.wHour),(m_oTrigPointTime.wMinute),dSec);

			double dRemain = (dSec - m_oTrigPointTime.wSecond ) * 1000;
			m_oTrigPointTime.wMilliseconds = (WORD)dRemain;

			dRemain = (dRemain - m_oTrigPointTime.wMilliseconds ) * 1000;
			m_oTrigPointTime.wMicroseconds = (WORD)dRemain;
		}
		else if (nIndex == m_nAllChs + 7 + m_nSamAmount) 
		{
			if (_stricmp(sString, g_pszKeyASCII) == 0)
			{
				m_nDataFileType = COMTRADE_DATAFILE_TYPE_ASCII;
			}
			else if (_stricmp(sString, g_pszKeyBinary) == 0)
			{
				m_nDataFileType = COMTRADE_DATAFILE_TYPE_BINARY;
			}
			else
			{
			}
		}
		else if (nIndex == m_nAllChs + 8 + m_nSamAmount) 
		{
			m_dTimeCoef = atof(sString);
			break;
		}
		else
		{
		}

		SetDataFileTypeByString(sString);//·ÀÖ¹cfgÎÄ¼þ¸ñÊ½ÓÐÎÊÌâµ¼ÖÂµÄ½âÎö³ö´í
		sString = oBuffer.NextString();
	}

	if (!ValidTotalPoints(strCFGFilePath))
	{
		return FALSE;
	}

	nTotalPoints = GetTotalPoints();

	POS pos = GetHeadPosition(); //zhouhj 20210918 ÐÞ¸Ä¶ÔÓÚASCIIÇé¿öÏÂ,Ã¿¸öÍ¨µÀµãÊý²ÉÓÃ2¸öunsigned int

	while (pos != NULL)
	{
		CComtradeDataBase* pObj = (CComtradeDataBase*)GetNext(pos);

		if (pObj->IsAnalogData())
		{
			if (m_bCreateBuffer)
			{
				if (m_nDataFileType)
				{
					pObj->AllocBuffer(nTotalPoints);
				} 
				else
				{
					pObj->AllocBuffer(nTotalPoints*2);
				}
			}
		}
		else
		{
			if (pObj->GetClassID()==GLOBALCLASSID_CCOMTRADERATEDATA)
			{
				continue;
			}

			if (nBinaryIndex % 16 == 0)
			{
				if (m_bCreateBuffer)
				{
					pObj->AllocBuffer(nTotalPoints);
					pBinaryPreBuffer = pObj->GetBuffer();
				}
			}
			else
			{
				pObj->AttachBuffer(pBinaryPreBuffer);
			}
		}
	}

	m_nTotalPoints = nTotalPoints;
	m_nBufLength2 = -1;
	m_nBufBeginPos2 = -1;
	m_nBufBeginPos1 = 0;
	m_nBufLength1 = m_pnDataPoints[0];
	m_nBufferLen = m_pnDataPoints[0];

	return TRUE;
}

void CRcdComtradeFile::BigComtrade_InitChsAllocBufferNext()
{
	POS pos = GetHeadPosition();
	CComtradeDataBase* pObj = NULL;
	int nFlag = 0;
	unsigned short* pBinaryPreBuffer = NULL;
	unsigned short uTmp = 0,uTmp2 = 0;

	while (pos != NULL)
	{
		pObj = (CComtradeDataBase*)GetNext(pos);

		if (pObj->GetClassID()==GLOBALCLASSID_CCOMTRADERATEDATA)
		{
			continue;
		}

		if (pObj->IsAnalogData())
		{
			pObj->InitBuffer_Circle(m_nDataFileType,m_nTotalPoints);
		}
		else
		{
			if (nFlag % 16 == 0)
			{
				pObj->InitBuffer_Circle(m_nDataFileType,m_nTotalPoints);
				pBinaryPreBuffer = pObj->GetBuffer();
			}
			else
			{
				pObj->AttachBuffer(pBinaryPreBuffer);
			}

			nFlag++;
		}
	}
}

void CRcdComtradeFile::ParseString(const CString& strIn, CString* pstrOut)
{
	CString strTemp = strIn;
	long nIndex = 0;
	long nPos = strTemp.FindOneOf(_T(","));
	long nLength = strTemp.GetLength();
	CString strLeft,strRight;

	while ( nPos >= 0)
	{
		strLeft = strTemp.Left(nPos);
		nLength = strTemp.GetLength();
		strRight = strTemp.Right(nLength - nPos -1);
		strTemp = strRight;
		pstrOut[nIndex] = strLeft;
		nIndex++;
		nPos = strTemp.FindOneOf(_T(","));
	}

	pstrOut[nIndex] = strTemp;
}

void CRcdComtradeFile::ParseString(const CString& strIn, CStringArray &straOut)
{
	straOut.RemoveAll();
	CString strTemp = strIn;
	long nIndex = 0;
	long nPos = strTemp.FindOneOf(_T(","));
	long nLength = strTemp.GetLength();
	CString strLeft,strRight;

	while ( nPos >= 0)
	{
		strLeft = strTemp.Left(nPos);
		nLength = strTemp.GetLength();
		strRight = strTemp.Right(nLength - nPos -1);
		strTemp = strRight;
		straOut.Add(strLeft);
		nIndex++;
		nPos = strTemp.FindOneOf(_T(","));
	}

	straOut.Add(strTemp);
}

void CRcdComtradeFile::ParseString_Char(char *pString, CStringArray &straOut)
{
	straOut.RemoveAll();

	if (pString == NULL)
	{
		return;
	}

	CString strTemp;
	char *pStartString = pString,*pCurString = pString;

	while(*pCurString != 0)
	{
		if (*pCurString == ',')
		{
			*pCurString = 0;
			strTemp = pStartString;
			straOut.Add(strTemp);
			*pCurString = ',';
			pCurString++;
			pStartString = pCurString;
		}

		pCurString++;
	}

	strTemp = pStartString;
	straOut.Add(strTemp);

// 	long nTotalLenth = strlen(pString);
// 	CString strTemp = strIn;
// 	long nIndex = 0;
// 	long nPos = strTemp.FindOneOf(_T(","));
// 	long nLength = strTemp.GetLength();
// 	CString strLeft,strRight;
// 
// 	while ( nPos >= 0)
// 	{
// 		strLeft = strTemp.Left(nPos);
// 		nLength = strTemp.GetLength();
// 		strRight = strTemp.Right(nLength - nPos -1);
// 		strTemp = strRight;
// 		straOut.Add(strLeft);
// 		nIndex++;
// 		nPos = strTemp.FindOneOf(_T(","));
// 	}
// 
// 	straOut.Add(strTemp);
}

long CRcdComtradeFile::ReadDataFile(const CString& strFilePath)
{
	BOOL bRet = FALSE;

	if (m_nDataFileType == COMTRADE_DATAFILE_TYPE_ASCII)
	{
		bRet = ReadDataAsASIIMode(strFilePath);
	}
	else
	{
		bRet = ReadDataAsBINARYMode(strFilePath);
	}

	return bRet;
}

long CRcdComtradeFile::GetTotalPoints()
{
	//2021-9-20  lijunqing
	if (m_pnDataPoints == NULL || m_nSamAmount == 0)
	{
		return 0;
	}

	long nIndex = 0;
	long nTotalPoints = 0;

	//»ñµÃ×ÜµÄÊý¾ÝµãÊý
	for(nIndex = 0; nIndex < m_nSamAmount; nIndex++)
	{
		nTotalPoints += m_pnDataPoints[nIndex];
	}

	return nTotalPoints;
}

long CRcdComtradeFile::GetChannelBuffferCount()
{
	long nBChs = m_nBinarys/16;
	if (m_nBinarys > nBChs * 16)
	{
		nBChs++;
	}

	return m_nAnalogs + nBChs;
}

double CRcdComtradeFile::CalCyclesBeforeStart()
{
	CGpsPcTime oGpsTime1(m_oTrigPointTime.wYear, m_oTrigPointTime.wMonth, m_oTrigPointTime.wDay
		, m_oTrigPointTime.wHour, m_oTrigPointTime.wMinute, m_oTrigPointTime.wSecond
		, m_oTrigPointTime.wMilliseconds, m_oTrigPointTime.wMicroseconds);

	CGpsPcTime oGpsTime2(m_oFirstPointTime.wYear, m_oFirstPointTime.wMonth, m_oFirstPointTime.wDay
		, m_oFirstPointTime.wHour, m_oFirstPointTime.wMinute, m_oFirstPointTime.wSecond
		, m_oFirstPointTime.wMilliseconds, m_oFirstPointTime.wMicroseconds);

	CGpsPcTimeSpan ts = oGpsTime1 - oGpsTime2;
	long nMs = ts.GetTotalMilliseconds();
	double dCycles = nMs;
	dCycles = dCycles * m_dFreq / 1000;

	return dCycles;
}

double CRcdComtradeFile::GetSampleRate(long nIndex)
{
	if (m_pdSamRate == NULL)
	{
		return 10000;
	}

	return m_pdSamRate[nIndex];
}

double CRcdComtradeFile::CalComtradeFileSumTime()
{
	double dTotalTime = 0;
	BOOL bIsFirstSmpRate = TRUE;// ·ÀÖ¹µÚÒ»¸ö²ÉÑùÂÊ,²ÉÑùµãÊýÎª0µÄÇé¿ö

	for (int nIndex = 0;nIndex<m_nSamAmount;nIndex++)
	{
		if (m_pnDataPoints[nIndex]<=0)
		{
			continue;
		}

		if (bIsFirstSmpRate)
		{
			dTotalTime = (1/m_pdSamRate[nIndex])*(m_pnDataPoints[nIndex]-1);
			bIsFirstSmpRate = FALSE;
		} 
		else
		{
			dTotalTime += (1/m_pdSamRate[nIndex])*(m_pnDataPoints[nIndex]);
		}
	}

	return dTotalTime;
}

long CRcdComtradeFile::GetBinarySinglePointLength()
{
	long nPointLength = 4+4;//ÐòºÅ¼°Ê±¼ä´Á³¤¶È
	nPointLength += m_nAnalogs*2;//Ä£ÄâÁ¿³¤¶È
	nPointLength += (m_nBinarys/16)*2;//¿ª¹ØÁ¿³¤¶È

	if (m_nBinarys%16 > 0)//Èç¹û²»Îª16µÄÕûÊý±¶,Ôò¼ÌÐøÔö¼Ó2¸ö×Ö½Ú
	{
		nPointLength += 2;
	}

	return nPointLength;
}

void CRcdComtradeFile::SetInPhase_SpecialSmpRate(BOOL bInPhase_SpecialSmpRate)
{
	POS pos = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pCurObj = NULL;

	while(pos)
	{
		pCurObj = (CComtradeAnalogData *)m_listAnalog.GetNext(pos);
		pCurObj->m_bInPhase_SpecialSmpRate = bInPhase_SpecialSmpRate;
	}
}

void CRcdComtradeFile::InitBeginAng_SpecialSmpRate(long nPointIndex,double dOffsetTime,double dFreq)
{
	if (nPointIndex>=m_nTotalPoints)
	{
		nPointIndex = m_nTotalPoints-1;
	}

	POS pos = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pCurObj = NULL;

	while(pos)
	{
		pCurObj = (CComtradeAnalogData *)m_listAnalog.GetNext(pos);
		pCurObj->m_dBeginAng_SpecialSmpRate = pCurObj->GetCurPointAng(m_pdSamRate,m_pnDataPoints,m_nSamAmount,dFreq,nPointIndex) + dOffsetTime*dFreq*2*_PI;

		while(pCurObj->m_dBeginAng_SpecialSmpRate>(2*_PI))
		{
			pCurObj->m_dBeginAng_SpecialSmpRate-= (2*_PI);
		}
	}
}

DWORD CRcdComtradeFile::GetCurPointTimeStamp(long nPointIndex)//zhouhj 20200911
{
	DWORD dwTimeStamp = 0/*0xFFFFFFFF*/;
	long nCurPointNum = 0;
	double dGapTime = 0;

	for (int nSmpRateIndex = 0; nSmpRateIndex<m_nSamAmount;nSmpRateIndex++)
	{
		if (m_pnDataPoints[nSmpRateIndex]<=0)//Ìø¹ý²ÉÑùµãÊýÎª0µÄ²ÉÑùÂÊ
		{
			continue;
		}

		dGapTime = (1000000/m_pdSamRate[nSmpRateIndex]);//²ÉÑùÂÊÏÂ²ÉÑùµãµÄ¼ä¸ôÊ±¼ä

		if (nPointIndex<=(nCurPointNum+m_pnDataPoints[nSmpRateIndex]))//ÅÐ¶Ï¸Ã²ÉÑùµãÊÇ·ñÔÚµ±Ç°²ÉÑùÆµÂÊ·¶Î§ÄÚ
		{
			dwTimeStamp += ((nPointIndex - nCurPointNum)*dGapTime);
			break;
		}

		nCurPointNum += m_pnDataPoints[nSmpRateIndex];

		if (dwTimeStamp == 0)//Èç¹ûÊÇµÚÒ»¸ö²ÉÑùµã£¬ÐèÒª¼õÈ¥1
		{
			dwTimeStamp += (m_pnDataPoints[nSmpRateIndex]-1)*dGapTime;
		} 
		else
		{
			dwTimeStamp += m_pnDataPoints[nSmpRateIndex]*dGapTime;
		}
	}

	if (m_dTimeCoef>0)
	{
		dwTimeStamp = dwTimeStamp/m_dTimeCoef;
	}

	return dwTimeStamp;
}

void CRcdComtradeFile::SetSamAmount(long nSamAmount)
{
	if (m_pnDataPoints != NULL)
	{
		delete []m_pnDataPoints;
	}

	if (m_pdSamRate != NULL)
	{
		delete []m_pdSamRate;
	}

	m_nSamAmount = nSamAmount;
	m_pnDataPoints = new long[m_nSamAmount];
	m_pdSamRate    = new float[m_nSamAmount];
}

void CRcdComtradeFile::SetSamValue(long nSamIndex, long nDataPoints, float fSampleRate)
{
	if (0 > nSamIndex || nSamIndex >= m_nSamAmount)
	{
		return;
	}

	m_pnDataPoints[nSamIndex] = nDataPoints;
	m_pdSamRate[nSamIndex] = fSampleRate;
}

void CRcdComtradeFile::SetSamPoints(long nSamIndex, long nDataPoints)
{
	if (0 > nSamIndex || nSamIndex >= m_nSamAmount)
	{
		return;
	}

	m_pnDataPoints[nSamIndex] = nDataPoints;
}

void CRcdComtradeFile::SetSamReate(long nSamIndex, float fSampleRate)
{
	if (0 > nSamIndex || nSamIndex >= m_nSamAmount)
	{
		return;
	}

	m_pdSamRate[nSamIndex] = fSampleRate;
}

long CRcdComtradeFile::CalDataPoints(const CString &strPath)
{
	FILE* pFile = NULL;
	CString strFile;
	//Edit by lipenghui 2020-04-15
	strFile.Format(_T("%s.%s"), strPath.GetString(), g_pszKeyDat);

#ifdef _PSX_QT_LINUX_
	if(!IsFileExist(strFile))
	{
        CString strTemp;
		strTemp = _T("dat");
		strFile = ChangeFilePostfix(strPath, strTemp);
		if(!IsFileExist(strFile))
		{
			return FALSE;
		}
	}

    QTextCodec *pOldTextCodec = NULL;
    InitLocalCodec_BeforeReadWrite(strFile,&pOldTextCodec);//½«±àÂë±äÎªutf-8
#endif

	char pszFile[MAX_PATH];
	CString_to_char(strFile, pszFile);
	pFile = fopen(pszFile,"rb");

#ifdef _PSX_QT_LINUX_
    ResetLocalCodec(pOldTextCodec);
    //system("sync");//20220616 Ð´ÎÄ¼þºóÐèÒªÍ¬²½
#endif

	long nPoints = 0;

	if (pFile != NULL)
	{
		fseek(pFile, 0, SEEK_END);
		long nPos = ftell(pFile);
		long nChs = GetChannelBuffferCount();
		nPoints = nPos / nChs;
	}
	else
	{
		nPoints = 655360;
	}

	nPoints /= 2;
	fclose(pFile);
	pFile = NULL;

	return nPoints;
}

void CRcdComtradeFile::GetSmpRateString(CString &strSmpRateString)
{
	strSmpRateString = _T("");

	for (int nIndex = 0;nIndex<m_nSamAmount;nIndex++)
	{
		strSmpRateString.AppendFormat(_T("SmpRate%dPoints=%d;"),nIndex+1,m_pnDataPoints[nIndex]);
	}
}

BOOL CRcdComtradeFile::ValidTotalPoints(const CString &strCfgFilePath)
{
	if ((m_nSamAmount == 0)||(m_pnDataPoints == NULL))
	{
		CLogPrint::LogFormatString(XLOGLEVEL_ERROR,_T("µ±Ç°²ÉÑùÂÊÊýÁ¿Îª0,×Ü²ÉÑùµãÊýÐ£ÑéÊ§°Ü."));
		return FALSE;
	}

	CString strTemp = CString(g_pszKeyDat);
	CString strDatFilePath = ChangeFilePostfix(strCfgFilePath, strTemp);

#ifdef _PSX_QT_LINUX_
	if(!IsFileExist(strDatFilePath))
	{
        strTemp = _T("dat");
		strDatFilePath = ChangeFilePostfix(strDatFilePath, strTemp);
		if(!IsFileExist(strDatFilePath))
		{
			CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("´ò¿ªdatÎÄ¼þ(%s)Ê§°Ü."), strDatFilePath.GetString());
			return FALSE;
		}
	}
#endif

	long nDataPoints = GetDataFilePoints(strDatFilePath);
	long nCfgPoints = GetTotalPoints();

	if (nDataPoints < nCfgPoints)//µ±datÎÄ¼þÖÐµÄµãÊýÐ¡ÓÚcfgÎÄ¼þÖÐµÄµãÊýÊ±,ÌáÊ¾ÐÞ¸Ä
	{
		long nErrorPoints = m_pnDataPoints[0];

		for (int nIndex = 1;nIndex<m_nSamAmount;nIndex++)
		{
			nErrorPoints += (m_pnDataPoints[nIndex]-m_pnDataPoints[nIndex-1]);
		}

		if (nErrorPoints == nDataPoints)
		{
			long nTmp = m_pnDataPoints[0];

			for (int nIndex = 1;nIndex<m_nSamAmount;nIndex++)
			{
				m_pnDataPoints[nIndex] -= nTmp;
				nTmp += m_pnDataPoints[nIndex];
			}

			return TRUE;
		}

		CString strSmpRateString;
		GetSmpRateString(strSmpRateString);

		if (strSmpRateString.GetLength()>1000)
		{
			CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("µ±Ç°CFGÎÄ¼þÖÐ±êÊ¶µÄ×ÜµãÊý%ld(²ÉÑùÂÊ²ÎÊýÒì³£),ÓëDATÎÄ¼þÖÐµÄÊµ¼Ê×ÜµãÊý%ld²»Ò»ÖÂ,ÇëÐÞ¸ÄCFGÎÄ¼þ.")
				, nCfgPoints,nDataPoints);
		} 
		else
		{
			CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("µ±Ç°CFGÎÄ¼þÖÐ±êÊ¶µÄ×ÜµãÊý%ld(%s),ÓëDATÎÄ¼þÖÐµÄÊµ¼Ê×ÜµãÊý%ld²»Ò»ÖÂ,ÇëÐÞ¸ÄCFGÎÄ¼þ.")
				, nCfgPoints,strSmpRateString.GetString(), nDataPoints);
		}
		
		return FALSE;
	}

	return TRUE;
}

long CRcdComtradeFile::GetDataFilePoints(const CString &strDataFilePath)
{
	long nPoints = 0;

	if (m_nDataFileType == 0)//ASCII
	{
		CBufferBase oASII_ModeBuffer;

		if (!oASII_ModeBuffer.ReadFromFile(strDataFilePath))
		{
			return 0;
		}

		oASII_ModeBuffer.FormatBuffer('\r');
		oASII_ModeBuffer.FormatBuffer('\n');
		char *sString = NULL;
		sString = oASII_ModeBuffer.GetString();

		while(oASII_ModeBuffer.IsPoiterInBuffer(sString))
		{
			nPoints++;
			sString = oASII_ModeBuffer.NextString();
		}
	}
	else//Binary
	{
#ifdef _PSX_QT_LINUX_
		QTextCodec *pOldTextCodec = NULL;
        InitLocalCodec_BeforeReadWrite(strDataFilePath,&pOldTextCodec);//½«±àÂë±äÎªutf-8
#endif

		FILE* pFile = NULL;
		pFile = fopen(strDataFilePath.GetString(),"rb");

#ifdef _PSX_QT_LINUX_
		ResetLocalCodec(pOldTextCodec);
		system("sync");//20220616 Ð´ÎÄ¼þºóÐèÒªÍ¬²½
#endif
		if (pFile == NULL)
		{
			return 0;
		}

		fseek(pFile,0,SEEK_END); //¶¨Î»µ½ÎÄ¼þÄ©
		long nFileLen = ftell(pFile);
		fclose(pFile);
		pFile = NULL;

// 		CFile oFile;
// 		if (!oFile.Open(strDataFilePath,CFile::modeRead))
// 		{
// 			return 0;
// 		}
// 
// 		long nFileLen = oFile.GetLength();
// 		oFile.Close();

		long nSinglePointLength = GetBinarySinglePointLength();
		nPoints = nFileLen / nSinglePointLength;
	}

	return nPoints;
}

long CRcdComtradeFile::ReadDataAsBINARYMode(const CString& strFilePath)
{
	if (m_pnDataPoints == NULL)
	{
		return 0;
	}

	//CMR1200BaseApp *//pApp = (CMR1200BaseApp*)AfxGetApp();
	long nIndex = 0;
	long nTotalPoints = GetTotalPoints();
	long nSteps = 20;
	long nStepPoints = nTotalPoints / nSteps;
	long nStep = 1;

	if (nStepPoints > 65536)
	{
		nStepPoints = 65536;
		nStepPoints = nTotalPoints / nSteps;
		nSteps = nTotalPoints / nStepPoints + 1;
	}

	long nStepIndex = 0;

	//»ñµÃ×ÜµÄÊý¾ÝµãÊý
	// 	for(nIndex = 0; nIndex < m_nSamAmount; nIndex++)
	// 	{
	// 		DWORD dwPoints = m_pnDataPoints[nIndex];
	// 		nTotalPoints += dwPoints;
	// 	}
	////g_theRecordApp.FireSysOptrMsg(MR1200_SYSOPTR_ONLINE_RECORD_DATA_COPY, SYSOPTRPARA_ONLINERECORDDATACOPY_BEGIN, MAKELONG(nStep, nSteps));

	unsigned short* pnBuffer = NULL;
	unsigned short* pnTemp = NULL;

	FILE* pFile = NULL;
	CString strDatFilePath;

	CString strTemp = CString(g_pszKeyDat);
	strDatFilePath = ChangeFilePostfix(strFilePath, strTemp);

#ifdef _PSX_QT_LINUX_
	if(!IsFileExist(strDatFilePath))
	{
        strTemp = _T("dat");
		strDatFilePath = ChangeFilePostfix(strFilePath, strTemp);
		if(!IsFileExist(strDatFilePath))
		{
			return FALSE;
		}
	}
	QTextCodec *pOldTextCodec = NULL;
    InitLocalCodec_BeforeReadWrite(strDatFilePath,&pOldTextCodec);//½«±àÂë±äÎªutf-8

#endif

	char pszDatFilePath[MAX_PATH];
	CString_to_char(strDatFilePath, pszDatFilePath);

//	long nFileSize = file_GetFileSize(pszDatFilePath);
	pFile = fopen(pszDatFilePath,"rb");

#ifdef _PSX_QT_LINUX_
	ResetLocalCodec(pOldTextCodec);
	//system("sync");//20220616 Ð´ÎÄ¼þºóÐèÒªÍ¬²½
#endif
	if (pFile == NULL)
	{
		return 0;
	}

	int  nSize = (int)(ceil(m_nBinarys / 16.0));
	nSize += (2 + 2 + m_nAnalogs);
	pnBuffer = new unsigned short[nSize];
	CComtradeDataBase* pObj = NULL;
	long nBinaryIndex = 0;
	long nAnalogIndex = 0;
	unsigned short* pBuffer = NULL;
	long nReadSize = 0;

	for (long nIndex = 0; nIndex < nTotalPoints; nIndex++)
	{
		nReadSize = fread(pnBuffer,2,nSize,pFile);//sizeof(unsigned short)

		if (nReadSize == 0)
		{
			break;
		}

		ReadDataAsBINARYMode(pnBuffer, nIndex);
		// 		pnTemp = pnBuffer + 4;//4ÊÇÊ±¼äºÍË÷ÒýËùÕ¼µÄ4¸ö×Ö
		// 		POS pos = GetHeadPosition();
		// 		nBinaryIndex = 0;
		// 		nAnalogIndex = 0;
		// 		
		// 		while (pos != NULL)
		// 		{
		// 			pObj = (CComtradeDataBase*)GetNext(pos);
		// 			pBuffer = pObj->GetBuffer();
		// 
		// 			if (pObj->IsAnalogData())
		// 			{			
		// 				pBuffer[nIndex] = *pnTemp;
		// 				pnTemp++;			
		// 				nAnalogIndex++;
		// 			}
		// 			else
		// 			{
		// 				if (pObj->GetClassID()==GLOBALCLASSID_CCOMTRADERATEDATA)
		// 				{
		// 					continue;
		// 				}
		// 				if (nBinaryIndex % 16 == 0)//Ã¿16¸ö×´Ì¬Ò»¸öshort
		// 				{
		// 					pBuffer[nIndex] = *pnTemp;
		// 					pnTemp++;
		// 				}
		// 				
		// 				nBinaryIndex++;
		// 			}
		// 		}

		nStepIndex++;

		if (nStepIndex >= nStepPoints)
		{
			nStepIndex = 0;
			//g_theRecordApp.FireSysOptrMsg(MR1200_SYSOPTR_ONLINE_RECORD_DATA_COPY, SYSOPTRPARA_ONLINERECORDDATACOPY_COPY, MAKELONG(nStep, nSteps));
			nStep++;
		}
	}

	fclose(pFile);
	pFile = NULL;
	UpdateAllChsTotalPointsNum();
	delete []pnBuffer;
	return nTotalPoints;
}

void CRcdComtradeFile::UpdateAllChsTotalPointsNum()
{
	//xupf ×ª»¯ÎªCData
	POS pos = GetHeadPosition();
	CComtradeDataBase* pObj = NULL;
	int nFlag = 0;

	while (pos != NULL)
	{
		pObj = (CComtradeDataBase*)GetNext(pos);

		if (pObj->GetClassID()==GLOBALCLASSID_CCOMTRADERATEDATA)
		{
			continue;
		}

		if (pObj->IsAnalogData())
		{
			pObj->m_nTotalPoints = m_nTotalPoints;
		}
		else
		{
			if (nFlag % 16 == 0)
			{
				pObj->m_nTotalPoints = m_nTotalPoints;
			}

			nFlag++;
		}
	}
}

unsigned short CRcdComtradeFile::CtringToUShort(const CString &strValue)
{
	unsigned short unValue = CString_To_ulong(strValue);
	return unValue;
}

// void WriteRecordDataFile(short nValue, CFile &oFile)
// {
// 	CString strText;
// 	strText.Format(_T("%d\t"), nValue);
// 	oFile.Write(strText, strText.GetLength());
// 	oFile.Write(_T("\r\n"), 2);
// }


void CRcdComtradeFile::ReadDataAsBINARYMode(unsigned short* pnBuffer, long nIndex)
{
	unsigned short* pnTemp = NULL;
	CComtradeDataBase* pObj = NULL;
	long nBinaryIndex = 0;
	long nAnalogIndex = 0;
	unsigned short* pBuffer = NULL;

	pnTemp = pnBuffer + 4;//4ÊÇÊ±¼äºÍË÷ÒýËùÕ¼µÄ4¸ö×Ö
	POS pos = GetHeadPosition();
	nBinaryIndex = 0;
	nAnalogIndex = 0;

	while (pos != NULL)
	{
		pObj = (CComtradeDataBase*)GetNext(pos);
		pBuffer = pObj->GetBuffer();

		if (pObj->IsAnalogData())
		{			
			pBuffer[nIndex] = *pnTemp;
			pnTemp++;			
			nAnalogIndex++;
		}
		else
		{
			if (pObj->GetClassID()==GLOBALCLASSID_CCOMTRADERATEDATA)
			{
				continue;
			}

			if (nBinaryIndex % 16 == 0)//Ã¿16¸ö×´Ì¬Ò»¸öshort
			{
				pBuffer[nIndex] = *pnTemp;
				pnTemp++;
			}

			nBinaryIndex++;
		}
	}
}

void CRcdComtradeFile::ReadDataAsASIIMode(char *pString, long nIndex)
{
	CStringArray straCurPointValues;
	ParseString_Char(pString,straCurPointValues);
	POS pos = GetHeadPosition();
	long nBinaryIndex = 0;
	long nAnalogIndex = 0;
	long nDataIndex = 2;//Ìø¹ýµÚÒ»¸ö¡¢µÚ¶þ¸öÖµ£¬¶ÔÓ¦±àºÅ¼°Ê±¼äµÄÖµ
	CComtradeDataBase* pObj = NULL;
	CComtradeAnalogData *pAnalogCh = NULL;
	int* pBuffer = NULL;
	unsigned short* pBufferBinary = NULL;
	CString strCurString;
	long nTmp = 0;

	//2024-7-23 wuxinyi ÐÞ¸Ä²¿·ÖÂ¼²¨ÎÄ¼þÓÐÎÊÌâµ¼ÖÂÖÐ¶Ï
	if(straCurPointValues.GetSize() <= nDataIndex)
	{
		return;
	}

	while (pos != NULL)
	{
		pObj = (CComtradeDataBase*)GetNext(pos);
		pBuffer = (int *)pObj->GetBuffer();
		pBufferBinary = (unsigned short*)pObj->GetBuffer();

		if (pObj->IsAnalogData())
		{
			strCurString = straCurPointValues.GetAt(nDataIndex);
			pAnalogCh = (CComtradeAnalogData *)pObj;
			pBuffer[nIndex] = static_cast<int>(CString_To_long(strCurString));	//zhouhj 20210918 ÔÚASCIIÇé¿öÏÂ,²ÉÓÃlongÊý¾Ý´æ´¢
			nAnalogIndex++;
			nDataIndex++;
		}
		else
		{
			if (pObj->GetClassID()==GLOBALCLASSID_CCOMTRADERATEDATA)
			{
				continue;
			}

			//2024-03-20 wuxinyi ÐÞ¸ÄasciiÎÄ¼þ ¿ª³öÁ¿´æ´¢
// 			if (nBinaryIndex % 16 == 0)//Ã¿16¸ö×´Ì¬Ò»¸öshort
// 			{
// 				strCurString = straCurPointValues.GetAt(nDataIndex);
// 				pBufferBinary[nIndex] = CtringToUShort(strCurString);	
// 				nDataIndex++;
// 			}
				
			if (nBinaryIndex % 16 == 0)//Ã¿16¸ö×´Ì¬Ò»¸öshort
			{
				unsigned short usValue = 0;
				for(int i = 0;i < 16; i++)
				{
					if(nDataIndex < straCurPointValues.GetSize())
					{
				strCurString = straCurPointValues.GetAt(nDataIndex);
						unsigned short usBitValue = CtringToUShort(strCurString);
						usValue |= (usBitValue ? 1ULL << i : 0ULL);
					}
					else
					{
						usValue &= ~(1ULL << i);//Ê£ÓàÎ»²¹0
					}
				nDataIndex++;
			}
				pBufferBinary[nIndex] = usValue;

			}				
			nBinaryIndex++;


		}
	}
}

long CRcdComtradeFile::ReadDataAsASIIMode(const CString& strFilePath)
{
	if (m_pnDataPoints == NULL)
	{
		return 0;
	}

	long nIndex = 0;
	long nTotalPoints = GetTotalPoints();
	long nSteps = 20;
	long nStepPoints = nTotalPoints / nSteps;
	long nStep = 1;

	if (nStepPoints > 65536)
	{
		nStepPoints = 65536;
		nStepPoints = nTotalPoints / nSteps;
		nSteps = nTotalPoints / nStepPoints + 1;
	}

	long nStepIndex = 0;
	CString strDatFilePath;
	CString strTemp = CString(g_pszKeyDat);
	strDatFilePath = ChangeFilePostfix(strFilePath, strTemp);

#ifdef _PSX_QT_LINUX_
	if(!IsFileExist(strDatFilePath))
	{
        strTemp = _T("dat");
		strDatFilePath = ChangeFilePostfix(strFilePath, strTemp);
		if(!IsFileExist(strDatFilePath))
		{
			return FALSE;
		}
	}
#endif

	CBufferBase oBuffer;
	char *sString = NULL;

	if (!oBuffer.ReadFromFile(strDatFilePath))
	{
		return 0;
	}

	oBuffer.FormatBuffer('\r');
	oBuffer.FormatBuffer('\n');

	for (long nIndex = 0; nIndex < nTotalPoints; nIndex++)
	{
		sString = oBuffer.GetString();

		if (!oBuffer.IsPoiterInBuffer(sString))
		{
			break;
		}

		ReadDataAsASIIMode(sString,nIndex);
		nStepIndex++;

		if (nStepIndex >= nStepPoints)
		{
			nStepIndex = 0;
			nStep++;
		}

		sString = oBuffer.NextString();
	}

	POS pos = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pAnalog = NULL;

	while(pos)
	{
		pAnalog = (CComtradeAnalogData*)m_listAnalog.GetNext(pos);

		// 		if ((pAnalog->m_nMin == 0)&&(pAnalog->m_nMax == 65535))
		// 		{
		// 			pAnalog->m_dZeroValue += 32767*pAnalog->m_dCoefValue; // ÔÚ´Ó·¶Î§0~65535  ×ª»¯Îª-32767 ~ 32767Ê±£¬¶ÔÓ¦µÄm_dZeroValueÐèÒªÐÞ¸Ä
		// 			pAnalog->m_nMin = 0;
		// 			pAnalog->m_nMax = 0;
		// 			pAnalog->m_dPrimaryValue = 1;
		// 			pAnalog->m_dSecondaryValue = 1;
		// 		}
	}

	m_nTotalPoints = nTotalPoints;
	UpdateAllChsTotalPointsNum();
	return nTotalPoints;
}

//´´½¨ComtradeÎÄ¼þ
void CRcdComtradeFile::CreateComtradeFile(long nAnalogChs, long nBinaryChs, long nTotalPoints)
{
	m_nBufBeginPos1 = 0;
	m_nBufLength1	= nTotalPoints;

	long nIndex = 0;
	CComtradeAnalogData *pAnalog = NULL;
	long nChannelIndex = 1;

	for (nIndex=0; nIndex<nAnalogChs; nIndex++)
	{
		pAnalog = new CComtradeAnalogData();

		if (m_nDataFileType == COMTRADE_DATAFILE_TYPE_BINARY)
		{
			pAnalog->AllocBuffer(nTotalPoints);
		} 
		else
		{
			pAnalog->AllocBuffer(nTotalPoints*2);
		}

		pAnalog->m_nChannelIndex = nChannelIndex++;

		AddNewChild(pAnalog);
		m_listAnalog.AddTail(pAnalog);
	}

	unsigned short *pRefBuffer = NULL;
	CComtradeBinaryData *pBinary = NULL;

	for (nIndex=0; nIndex<nBinaryChs; nIndex++)
	{
		pBinary = new CComtradeBinaryData();
		pBinary->m_nDataIndex = nIndex % 16;
		pBinary->m_nChannelIndex = nChannelIndex++;

		AddNewChild(pBinary);
		m_listBinary.AddTail(pBinary);

		if (pBinary->m_nDataIndex == 0)
		{
			pBinary->AllocBuffer(nTotalPoints);
			pRefBuffer = pBinary->m_pnAttachBuffer;
		}
		else
		{
			pBinary->AttachBuffer(pRefBuffer);
		}
	}

	m_nTotalPoints = nTotalPoints;

}

CRcdComtradeFile* CRcdComtradeFile::CloneComtradeWithSingleSmpRate(double dSmpRate,const double &dDstBeginOffsetTime)
{
	CRcdComtradeFile* pFile = new CRcdComtradeFile(TRUE);
	CopyOwn(pFile);//¿½±´CfgÎÄ¼þÖÐµÄÏà¹Ø²ÎÊýÊý¾Ý
	pFile->SetSamAmount(1);//ÉèÖÃÖ»ÓÐÒ»¸ö²ÉÑùÂÊ
	pFile->m_pdSamRate[0] = dSmpRate;//ÉèÖÃÊµ¼Ê²ÉÑùÂÊ
	double dTotalTime = CalComtradeFileSumTime() - dDstBeginOffsetTime;//»ñÈ¡×ÜÊ±³¤
	pFile->m_pnDataPoints[0] = (dTotalTime*dSmpRate+2);//¸ù¾Ý×ÜÊ±³¤¼ÆËã×ÜµÄ²ÉÑùµãÊý,¶ÔÓÚ²»ÎªÕûÊý¸öÊýµÄ,Ö»±£ÁôÕû¸öÊ±¼ä¶ÎÀïµÄ²ÉÑùµã
	pFile->m_nTotalPoints = pFile->m_pnDataPoints[0];

	pFile->m_nDataFileType = m_nDataFileType;
	pFile->CreateComtradeFile(m_nAnalogs,m_nBinarys,pFile->m_pnDataPoints[0]);//´´½¨ËùÓÐÍ¨µÀ,Ä£ÄâÁ¿¡¢Êý×ÖÁ¿¡¢²ÉÑùÂÊ
	pFile->m_nComtradeVersion = 1999;

	CExBaseList *pSmpRates = pFile->GetRates();
	CComtradeRateData *pRateData = new CComtradeRateData();
	pFile->AddNewChild(pRateData);
	pSmpRates->AddTail(pRateData);
	pRateData->m_nSamprate = dSmpRate;//¸øÊµ¼Ê²ÉÑùÂÊ¸³Öµ
	pRateData->m_nEndsamp = pFile->m_pnDataPoints[0];

	CExBaseList *pAnalogList = pFile->GetAnalogs();
	CExBaseList *pBinaryList = pFile->GetBinarys();
	POS pos_ch = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pSrcAnalogData = NULL;
	CComtradeAnalogData *pDstAnalogData = NULL;
	long nChIndex = 0;
	long nActTotalPoints = pFile->m_nTotalPoints;

	while(pos_ch)
	{
		pSrcAnalogData = (CComtradeAnalogData *)m_listAnalog.GetNext(pos_ch);
		pDstAnalogData = (CComtradeAnalogData *)pAnalogList->GetAtIndex(nChIndex);
		nActTotalPoints = pSrcAnalogData->InsertBySampleRate(m_pdSamRate,m_pnDataPoints,m_nSamAmount,dSmpRate, pDstAnalogData,dDstBeginOffsetTime);
		nChIndex++;
	}

	CComtradeBinaryData *pSrcBinaryData = NULL;
	CComtradeBinaryData *pDstBinaryData = NULL;
	nChIndex = 0;
	pos_ch = m_listBinary.GetHeadPosition();

	while(pos_ch)
	{
		pSrcBinaryData = (CComtradeBinaryData *)m_listBinary.GetNext(pos_ch);
		pDstBinaryData = (CComtradeBinaryData *)pBinaryList->GetAtIndex(nChIndex);

		if (pSrcBinaryData->m_nDataIndex == 0)
		{
			pSrcBinaryData->InsertBySampleRate(m_pdSamRate,m_pnDataPoints,m_nSamAmount,dSmpRate, pDstBinaryData,dDstBeginOffsetTime);
		}
		else
		{
			pSrcBinaryData->CopyOwn(pDstBinaryData);
		}

		nChIndex++;
	}

	ASSERT(pFile->m_nTotalPoints  >= nActTotalPoints);
	pFile->m_nTotalPoints = nActTotalPoints;
	pFile->m_pnDataPoints[0] = nActTotalPoints;
	pFile->UpdateAllChsTotalPointsNum();
	return pFile;
}

CRcdComtradeFile* CRcdComtradeFile::CloneComtrade_AddSlowlyRising(double dSecondTime,long nAddCircleStartNum,long nAddCircleEndNum)
{
	CRcdComtradeFile* pFile = new CRcdComtradeFile(TRUE);
	CopyOwn(pFile);//¿½±´CfgÎÄ¼þÖÐµÄÏà¹Ø²ÎÊýÊý¾Ý
	ASSERT(m_pnDataPoints[0]>0);
	long nAddSlowlyRisingPoints = dSecondTime*m_pdSamRate[0];//Ìí¼ÓµÄ»ºÂýÉÏÉýµÄµãÊý
	long nAddStartSteadyPoints = nAddCircleStartNum*m_pdSamRate[0]/50;//Ìí¼ÓµÄÎÈÌ¬µãÊý
	long nAddEndSteadyPoints = nAddCircleEndNum*m_pdSamRate[m_nSamAmount-1]/50;
	pFile->m_pnDataPoints[0] += (nAddSlowlyRisingPoints+nAddStartSteadyPoints);
	pFile->m_pnDataPoints[m_nSamAmount-1] += (nAddEndSteadyPoints);
	pFile->m_nTotalPoints += (nAddSlowlyRisingPoints+nAddStartSteadyPoints+nAddEndSteadyPoints);
	pFile->CreateComtradeFile(m_nAnalogs,m_nBinarys,pFile->m_nTotalPoints);//´´½¨ËùÓÐÍ¨µÀ,Ä£ÄâÁ¿¡¢Êý×ÖÁ¿¡¢²ÉÑùÂÊ
	pFile->m_nComtradeVersion = 1999;
	pFile->m_nDataFileType = m_nDataFileType;
	pFile->UpdateSmpRatesList();

	CExBaseList *pAnalogList = pFile->GetAnalogs();
	CExBaseList *pBinaryList = pFile->GetBinarys();
	POS pos_ch = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pSrcAnalogData = NULL;
	CComtradeAnalogData *pDstAnalogData = NULL;
	long nChIndex = 0;
	long nTwoSineWavePoints = 2*m_pdSamRate[m_nSamAmount-1]/50;//×îºóÁ½¸öÖÜ²¨µÄ×ÜµãÊý

	while(pos_ch)
	{
		pSrcAnalogData = (CComtradeAnalogData *)m_listAnalog.GetNext(pos_ch);
		pDstAnalogData = (CComtradeAnalogData *)pAnalogList->GetAtIndex(nChIndex);
		pSrcAnalogData->Copy_AddSlowlyRising(m_pdSamRate[0],nAddSlowlyRisingPoints,nAddStartSteadyPoints,pDstAnalogData,TRUE);
		pDstAnalogData->m_nTotalPoints = pFile->m_nTotalPoints;

		if (nAddCircleEndNum>0)
		{
			pDstAnalogData->SetSteadySineWave(m_pdSamRate[m_nSamAmount-1],pSrcAnalogData->m_nTotalPoints+nAddSlowlyRisingPoints+nAddStartSteadyPoints-nTwoSineWavePoints,nAddEndSteadyPoints+nTwoSineWavePoints);//×îºóÁ½¸öÖÜ²¨¼ÓÉÏÐÂÔöµÄÎÈÌ¬ÖÜ²¨£¬È«²¿ÖØÐÂÉèÖÃµãÖµ
		}

		nChIndex++;
	}

	CComtradeBinaryData *pSrcBinaryData = NULL;
	CComtradeBinaryData *pDstBinaryData = NULL;
	nChIndex = 0;
	pos_ch = m_listBinary.GetHeadPosition();

	while(pos_ch)
	{
		pSrcBinaryData = (CComtradeBinaryData *)m_listBinary.GetNext(pos_ch);
		pDstBinaryData = (CComtradeBinaryData *)pBinaryList->GetAtIndex(nChIndex);

		if (pSrcBinaryData->m_nDataIndex == 0)
		{
//			pSrcBinaryData->InsertBySampleRate(m_pdSamRate,m_pnDataPoints,m_nSamAmount,dSmpRate, pDstBinaryData,dDstBeginOffsetTime);
		}
		else
		{
			pSrcBinaryData->CopyOwn(pDstBinaryData);
		}

		nChIndex++;
	}

	pFile->UpdateAllChsTotalPointsNum();
	return pFile;
}

long CRcdComtradeFile::CalTotalPoints_InsertWithSingleSmpRate(double dSmpRate,const double &dDstBeginOffsetTime)
{
	double dTotalTime = CalComtradeFileSumTime() - dDstBeginOffsetTime;//»ñÈ¡×ÜÊ±³¤
	double dCalTotalPoints = dTotalTime*dSmpRate;//¸ù¾Ý×ÜÊ±³¤¼ÆËã×ÜµÄ²ÉÑùµãÊý,¶ÔÓÚ²»ÎªÕûÊý¸öÊýµÄ,Ö»±£ÁôÕû¸öÊ±¼ä¶ÎÀïµÄ²ÉÑùµã
	long nCalTotalPoints = dCalTotalPoints;

	if (fabs(nCalTotalPoints+1-dCalTotalPoints)<0.00001)//ÐèÒª¼ÓÉÏµÚÒ»¸öµã£¬Í¬Ê±ÐèÒª¿¼ÂÇÒòÎª¾«¶È¶ªÊ§ÉáÈ¥µÄÒ»¸öµã
	{
		nCalTotalPoints += 2;
	} 
	else
	{
		nCalTotalPoints += 1;
	}

	return nCalTotalPoints;
}

void CRcdComtradeFile::InitAnalogChsIncreaseValue(long nMaxValue)
{
	POS pos = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pAnalogCh = NULL;
	long nIndex = 0;
	long nChValue = 1;
	int *pnAttachBuffer = NULL;

	while(pos)
	{
		pAnalogCh = (CComtradeAnalogData*)m_listAnalog.GetNext(pos);
		pnAttachBuffer = (int*)pAnalogCh->m_pnAttachBuffer;
		nChValue = 1;

		for (nIndex = 0;nIndex<m_nTotalPoints;nIndex++)
		{
			if (m_nDataFileType == COMTRADE_DATAFILE_TYPE_BINARY)
			{
				pAnalogCh->m_pnAttachBuffer[nIndex] = nChValue;
			} 
			else
			{
				pnAttachBuffer[nIndex] = nChValue;
			}

			nChValue++;

			if (nChValue>nMaxValue)
			{
				nChValue = 1;
			}
		}
	}
}

BOOL CRcdComtradeFile::SetAnalogAttr(long nAnalog, const CString &strName, const CString &strChID, const CString &strUnit
									 , float fZero, float fCoef, float fPrimary, float fSecondary
									 , unsigned short** ppnAttachBuffer)
{
	CComtradeAnalogData *pAnalog = (CComtradeAnalogData*)m_listAnalog.GetAtIndex(nAnalog);

	if (pAnalog == NULL)
	{
		*ppnAttachBuffer = NULL;
		return FALSE;
	}

	pAnalog->m_strName = strName;
	pAnalog->m_strID = strName;
	pAnalog->m_strUnit = strUnit;
	pAnalog->m_strPhaseID = strChID;
	pAnalog->m_dCoefValue = fCoef;
	pAnalog->m_dZeroValue = fZero;
	pAnalog->m_dPrimaryValue = fPrimary;
	pAnalog->m_dSecondaryValue = fSecondary;

	*ppnAttachBuffer = pAnalog->m_pnAttachBuffer;

	return TRUE;
}

BOOL CRcdComtradeFile::SetAnalogData(long nAnalog, const CString &strName, const CString &strChID, const CString &strUnit
									 , float fZero, float fCoef, float fPrimary, float fSecondary
									 , double *pdBuffer)
{
	CComtradeAnalogData *pAnalog = (CComtradeAnalogData*)m_listAnalog.GetAtIndex(nAnalog);

	if (pAnalog == NULL)
	{
		pAnalog = new CComtradeAnalogData();
		m_listAnalog.AddNewChild(pAnalog);

		if (m_nDataFileType)
		{
			pAnalog->AllocBuffer(m_nTotalPoints);
		} 
		else
		{
			pAnalog->AllocBuffer(m_nTotalPoints*2);
		}
	}

	pAnalog->m_nChannelIndex = nAnalog;
	pAnalog->m_strName = strName;
	pAnalog->m_strID = strChID;
	pAnalog->m_strPhaseID = strChID;
	pAnalog->m_strUnit = strUnit;
	pAnalog->m_dCoefValue = fCoef;
	pAnalog->m_dZeroValue = fZero;
	pAnalog->m_dPrimaryValue = fPrimary;
	pAnalog->m_dSecondaryValue = fSecondary;

	pAnalog->AllocBuffer(m_nTotalPoints);

	if (m_nDataFileType == COMTRADE_DATAFILE_TYPE_BINARY)
	{
		unsigned short *pRcdBuf = pAnalog->GetBuffer();

		long nIndex = 0;

		for (nIndex=0; nIndex<m_nTotalPoints; nIndex++)
		{
			pRcdBuf[nIndex] = (unsigned short)(pdBuffer[nIndex] / fCoef);
		}
	} 
	else
	{
		int *pRcdBuf = (int*)pAnalog->GetBuffer();

		long nIndex = 0;

		for (nIndex=0; nIndex<m_nTotalPoints; nIndex++)
		{
			pRcdBuf[nIndex] = (int)(pdBuffer[nIndex] / fCoef);
		}
	}

	return TRUE;
}

void CRcdComtradeFile::InitAfterCreate(float fFreq, long nSampRate, long nTotolPoints)
{
	m_nSamAmount = 1;
	m_dFreq = fFreq;
	m_pnDataPoints = new long[1];
	m_pnDataPoints[0] = nTotolPoints;
	m_pdSamRate = new float[1];
	m_pdSamRate[0] = nSampRate;

	m_nTotalPoints = nTotolPoints;
	CalMinMaxValue();
}

long CRcdComtradeFile::XmlReadOwn( CXmlRWNodeBase &oNode, CXmlRWKeys *pXmlRWKeys )
{
	CComtradeFileXmlRWKeys *pXmlKeys = (CComtradeFileXmlRWKeys*)pXmlRWKeys;

	xml_GetAttibuteValue(pXmlKeys->m_strNameKey, oNode, m_strStationName);
	xml_GetAttibuteValue(pXmlKeys->m_strIDKey, oNode, m_strRecordingDeviceID);
	xml_GetAttibuteValue(pXmlKeys->m_strVersionKey, oNode, m_nComtradeVersion);
	xml_GetAttibuteValue(pXmlKeys->m_strAllchsKey, oNode, m_nAllChs);
	xml_GetAttibuteValue(pXmlKeys->m_strUIchsKey, oNode, m_nAnalogs);
	xml_GetAttibuteValue(pXmlKeys->m_strStatechKey, oNode, m_nBinarys);
	xml_GetAttibuteValue(pXmlKeys->m_strFreqKey, oNode, m_dFreq);
	xml_GetAttibuteValue(pXmlKeys->m_strRatesKey, oNode, m_nSamAmount);
	xml_GetAttibuteValue(pXmlKeys->m_strFirstpttmKey, oNode, m_strFirstPointTime);
	xml_GetAttibuteValue(pXmlKeys->m_strTriptmKey, oNode, m_strTrigPointTime);
	xml_GetAttibuteValue(pXmlKeys->m_strDatafiletypeKey, oNode, m_nDataFileType);
	xml_GetAttibuteValue(pXmlKeys->m_strTmmultKey, oNode, m_dTimeCoef);
	return 0;
}

long CRcdComtradeFile::XmlWriteOwn( CXmlRWDocBase &oXMLDoc, CXmlRWElementBase &oElement, CXmlRWKeys *pXmlRWKeys )
{
	CComtradeFileXmlRWKeys *pXmlKeys = (CComtradeFileXmlRWKeys*)pXmlRWKeys;

	xml_SetAttributeValue(pXmlKeys->m_strNameKey, oElement, m_strStationName);
	xml_SetAttributeValue(pXmlKeys->m_strIDKey, oElement, m_strRecordingDeviceID);
	xml_SetAttributeValue(pXmlKeys->m_strVersionKey, oElement, m_nComtradeVersion);
	xml_SetAttributeValue(pXmlKeys->m_strAllchsKey, oElement, m_nAllChs);
	xml_SetAttributeValue(pXmlKeys->m_strUIchsKey, oElement, m_nAnalogs);
	xml_SetAttributeValue(pXmlKeys->m_strStatechKey, oElement, m_nBinarys);
	xml_SetAttributeValue(pXmlKeys->m_strFreqKey, oElement, m_dFreq);
	xml_SetAttributeValue(pXmlKeys->m_strRatesKey, oElement, m_nSamAmount);
	xml_SetAttributeValue(pXmlKeys->m_strFirstpttmKey, oElement, m_strFirstPointTime);
	xml_SetAttributeValue(pXmlKeys->m_strTriptmKey, oElement, m_strTrigPointTime);
	xml_SetAttributeValue(pXmlKeys->m_strDatafiletypeKey, oElement, m_nDataFileType);
	xml_SetAttributeValue(pXmlKeys->m_strTmmultKey, oElement, m_dTimeCoef);
	return 0;
}
// #include <QDebug>
CExBaseObject* CRcdComtradeFile::CreateNewChild( const CString &strClassID, BOOL &bAddToTail, CXmlRWKeys *pXmlRWKeys )
{
	CExBaseObject *pNew  = NULL;
	CComtradeFileXmlRWKeys *pXmlKeys = (CComtradeFileXmlRWKeys*)pXmlRWKeys;

	//qDebug()<<strClassID;
	if (strClassID == pXmlKeys->m_strCComtradeAnalogDataKey)
	{
		pNew = new CComtradeAnalogData();
		m_listAnalog.AddTail(pNew);
	}
	else if (strClassID == pXmlKeys->m_strCComtradeBinaryDataKey)
	{
		pNew = new CComtradeBinaryData();
		m_listBinary.AddTail(pNew);
	}
	else if (strClassID == pXmlKeys->m_strCComtradeRateDataKey)
	{
		pNew = new CComtradeRateData();
		m_listRates.AddTail(pNew);
	}

	return pNew;
}

CExBaseObject* CRcdComtradeFile::CreateNewChild( long nClassID/*, BOOL &bAddToTail*/ )
{
	CExBaseObject *pNew  = NULL;


	if (nClassID == GLOBALCLASSID_CCOMTRADEANALOGDATA)
	{
		pNew = new CComtradeAnalogData();
		m_listAnalog.AddTail(pNew);
	}
	else if (nClassID == GLOBALCLASSID_CCOMTRADEBINARYDATA)
	{
		pNew = new CComtradeBinaryData();
		m_listBinary.AddTail(pNew);
	}
	else if (nClassID == GLOBALCLASSID_CCOMTRADERATEDATA)
	{
		pNew = new CComtradeRateData();
		m_listRates.AddTail(pNew);
	}

	return pNew;
}

BOOL CRcdComtradeFile::CopyOwn(CBaseObject* pDest)
{
	if(this == pDest)
	{
		return TRUE;
	}

	CExBaseObject::CopyOwn(pDest);

	CRcdComtradeFile *p = (CRcdComtradeFile*)pDest;
	p->m_strComtradeFile = m_strComtradeFile;
	p->m_strBasicInfo = m_strBasicInfo;
	p->m_oTrigPointTime = m_oTrigPointTime;
	p->m_oFirstPointTime = m_oFirstPointTime;
	p->m_nBufBeginPos1 = m_nBufBeginPos1;
	p->m_nBufBeginPos2 = m_nBufBeginPos2;
	p->m_nBufLength1 = m_nBufLength1;
	p->m_nBufLength2 = m_nBufLength2;
	p->m_nBufferLen = m_nBufferLen;
	p->m_nTotalPoints = m_nTotalPoints;
	p->m_oComtradeFile = m_oComtradeFile;
	p->m_nComtradeVersion = m_nComtradeVersion;
	p->m_strStationName = m_strStationName;
	p->m_strRecordingDeviceID = m_strRecordingDeviceID;
	p->m_nAllChs = m_nAllChs;
	p->m_nAnalogs = m_nAnalogs;
	p->m_nBinarys = m_nBinarys;
	p->m_dFreq = m_dFreq;
	//	p->m_nSamAmount = m_nSamAmount;
	p->m_strTrigPointTime = m_strTrigPointTime;
	p->m_strFirstPointTime = m_strFirstPointTime;
	p->m_dTimeCoef = m_dTimeCoef;
	p->m_nDataFileType = m_nDataFileType;
	p->m_nSaveGap = m_nSaveGap;
	p->m_bCreateBuffer = m_bCreateBuffer;

	p->SetSamAmount(m_nSamAmount);

	for (long nIndex = 0;nIndex<m_nSamAmount;nIndex++)
	{
		p->m_pdSamRate[nIndex] = m_pdSamRate[nIndex];
		p->m_pnDataPoints[nIndex] = m_pnDataPoints[nIndex];
	}

	return TRUE;
}

void CRcdComtradeFile::CalUIMax(double &fUMax,double &fIMax)
{
	CComtradeAnalogData *pData = NULL;
	POS pos = m_listAnalog.GetHeadPosition();

	double fVal = 0;
	fUMax = -100;
	fIMax = -100;

	while(pos != NULL)
	{
		pData = (CComtradeAnalogData *)m_listAnalog.GetNext(pos);
		fVal = pData->m_nMaxCal * pData->m_dCoefValue + pData->m_dZeroValue;

		if (pData->IsAnalogUData())
		{
			if (fUMax < fVal)
			{
				fUMax = fVal;
			}
		}
		else
		{
			if (fIMax < fVal)
			{
				fIMax = fVal;
			}
		}
	}
}

long CRcdComtradeFile::GetCurrPosByTime(double dTime)
{
	if ((m_pdSamRate == NULL)||(m_pnDataPoints == NULL))
	{
		return 0;
	}

	double dCurrTime = 0.0f,dIntervalTime = 0.0f,dCurrSmpRateMaxTime = 0.0f;
	long nCurrPos = 0;

	for (long nIndex = 0;nIndex<m_nSamAmount;nIndex++)
	{
		dIntervalTime = 1/m_pdSamRate[nIndex];
		dCurrSmpRateMaxTime = dIntervalTime*m_pnDataPoints[nIndex];

		if ((dCurrSmpRateMaxTime+dCurrTime)>=dTime)
		{
			nCurrPos += ((dTime - dCurrTime)/dIntervalTime + 0.0001);
			break;
		} 
		else
		{
			nCurrPos += (dCurrSmpRateMaxTime/dIntervalTime + 0.0001);
			dCurrTime += dCurrSmpRateMaxTime;
		}
	}

	return nCurrPos;
}


BOOL CRcdComtradeFile::InsertCyclePointsByRelTime( double dBeginTime, double dEndTime, double dInsertTime, int nCycleIndex )
{
	long nBeginPos = GetCurrPosByTime(dBeginTime);
	long nEndPos = GetCurrPosByTime(dEndTime);
	long nInsertLength = nEndPos - nBeginPos;
	long nInsertPos = GetCurrPosByTime(dInsertTime);

	// È·±£ÆðµãÐ¡ÓÚÖÕµã£¬²¢ÇÒÆðµãºÍÖÕµã¶¼Ð¡ÓÚ×ÜµãÊý
	if (nBeginPos > nEndPos || nBeginPos >= m_nTotalPoints || nEndPos >= m_nTotalPoints) 
	{
		CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("²åÈëÊ±¼ä¶ÎµãÊý´íÎó£¬ÇëÖØÐÂ¼ì²éºóÔÙ´ÎÊäÈë£¡"));
		return FALSE;
	}

	POS pos_ch = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pAnalogData = NULL;

	while(pos_ch)
	{
		pAnalogData = (CComtradeAnalogData *)m_listAnalog.GetNext(pos_ch);
		pAnalogData->InsertCyclePoints(nBeginPos, nEndPos, nInsertPos, nCycleIndex,m_nDataFileType);
	}

	POS pos_BinaryCh = m_listBinary.GetHeadPosition();
	CComtradeBinaryData *pBinaryData = NULL;
	while (pos_BinaryCh)
	{
		pBinaryData = (CComtradeBinaryData *)m_listBinary.GetNext(pos_BinaryCh);
		pBinaryData->InsertCyclePoints(nBeginPos, nEndPos, nInsertPos, nCycleIndex,m_nDataFileType);
	}

	UpdateSamDateAfterInsert(nBeginPos, nEndPos, nInsertPos, nCycleIndex);
	m_nTotalPoints += (nInsertLength/*+ 1*/) * nCycleIndex ;

// 	m_pnDataPoints[0] = m_nTotalPoints;
//	UpdateSmpRatesList();//zhouhj 2024.1.20ÔÚ¸üÐÂ²ÉÑùÂÊ¹ý³ÌÖÐ¸üÐÂ
// 	CalMinMaxValue();//É¾³ýÖØÐÂ¼ÆËã×î´ó×îÐ¡Öµ

	return TRUE;
}


BOOL CRcdComtradeFile::InsertCyclePointsByPoint( long nBeginPoint, long nEndPoint, long nInserPoint, int nCycleIndex )
{
	long nBeginPos = nBeginPoint;
	long nEndPos = nEndPoint;
	long nInsertLength = nEndPos - nBeginPos;
	long nInsertPos = nInserPoint;

	// È·±£ÆðµãÐ¡ÓÚÖÕµã£¬²¢ÇÒÆðµãºÍÖÕµã¶¼Ð¡ÓÚ×ÜµãÊý
	if (nBeginPos > nEndPos || nBeginPos > m_nTotalPoints || nEndPos > m_nTotalPoints) 
	{
		CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("²åÈëÊ±¼ä¶ÎµãÊý´íÎó£¬ÇëÖØÐÂ¼ì²éºóÔÙ´ÎÊäÈë£¡"));
		return FALSE;
	}

	POS pos_ch = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pAnalogData = NULL;

	while(pos_ch)
	{
		pAnalogData = (CComtradeAnalogData *)m_listAnalog.GetNext(pos_ch);
		pAnalogData->InsertCyclePoints(nBeginPos, nEndPos, nInsertPos, nCycleIndex,m_nDataFileType);
	}

	POS pos_BinaryCh = m_listBinary.GetHeadPosition();
	CComtradeBinaryData *pBinaryData = NULL;
	while (pos_BinaryCh)
	{
		pBinaryData = (CComtradeBinaryData *)m_listBinary.GetNext(pos_BinaryCh);
		pBinaryData->InsertCyclePoints(nBeginPos, nEndPos, nInsertPos, nCycleIndex,m_nDataFileType);
	}

	UpdateSamDateAfterInsert(nBeginPos, nEndPos, nInsertPos, nCycleIndex);
	m_nTotalPoints += (nInsertLength/*+ 1*/) * nCycleIndex ;

	// 	m_pnDataPoints[0] = m_nTotalPoints;
	//	UpdateSmpRatesList();//zhouhj 2024.1.20ÔÚ¸üÐÂ²ÉÑùÂÊ¹ý³ÌÖÐ¸üÐÂ
// 	CalMinMaxValue();//É¾³ýÖØÐÂ¼ÆËã×î´ó×îÐ¡Öµ

	return TRUE;
}

BOOL CRcdComtradeFile::DeletePointsByRelTime( double dBeginTime, double dEndTime )
{
	long nBeginPos = GetCurrPosByTime(dBeginTime);
	long nEndPos = GetCurrPosByTime(dEndTime);

	// È·±£ÆðµãÐ¡ÓÚÖÕµã£¬²¢ÇÒÆðµãºÍÖÕµã¶¼Ð¡ÓÚ×ÜµãÊý
	if (nBeginPos >= nEndPos || nBeginPos >= m_nTotalPoints) 
	{
		CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("É¾³ýÊ±¼ä¶ÎµãÊý´íÎó£¬ÇëÖØÐÂ¼ì²éºóÔÙ´ÎÊäÈë£¡"));
		return FALSE;
	}
	else if(nEndPos >= m_nTotalPoints)
	{
		CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("É¾³ýÊ±¿Ì³¬¹ý²¨ÐÎ×ÜÊ±¶Î£¬ÇëÖØÐÂ¼ì²éºóÔÙ´ÎÊäÈë£¡"));
		return FALSE;
	}

	long nDeleteLength = nEndPos - nBeginPos;

	POS pos_ch = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pAnalogData = NULL;

	while(pos_ch)
	{
		pAnalogData = (CComtradeAnalogData *)m_listAnalog.GetNext(pos_ch);
		pAnalogData->DeletePoints(nBeginPos, nEndPos,m_nDataFileType);
	}

	POS pos_BinaryCh = m_listBinary.GetHeadPosition();
	CComtradeBinaryData *pBinaryData = NULL;
	while (pos_BinaryCh)
	{
		pBinaryData = (CComtradeBinaryData *)m_listBinary.GetNext(pos_BinaryCh);
		pBinaryData->DeletePoints(nBeginPos, nEndPos,m_nDataFileType);
	}

	UpdateSamDateAfterDelete(nBeginPos, nEndPos);
	m_nTotalPoints -= nDeleteLength;// ¸üÐÂ×ÜµãÊý

//	UpdateSmpRatesList();//zhouhj 2024.1.20ÔÚ¸üÐÂ²ÉÑùÂÊ¹ý³ÌÖÐ¸üÐÂ
	CalMinMaxValue();//É¾³ýÖØÐÂ¼ÆËã×î´ó×îÐ¡Öµ
	return TRUE;
}

BOOL CRcdComtradeFile::InsertNormalCyclePoints(double dVolValue,double dCurrentValue,double dTime_Second)
{
	if ((m_pdSamRate == NULL)||(m_pnDataPoints == NULL))
	{
		CLogPrint::LogFormatString(XLOGLEVEL_ERROR,_T("µ±Ç°²¨ÐÎÈ±ÉÙ²ÉÑùÂÊÊý¾Ý."));
		return FALSE;
	}

	long nInsertPoints = dTime_Second*m_pdSamRate[0];//²åÈëµÄ²ÉÑùµãÊý
	m_pnDataPoints[0] += nInsertPoints;

	POS pos_ch = m_listAnalog.GetHeadPosition();
	CComtradeAnalogData *pAnalogData = NULL;

	while(pos_ch)
	{
		pAnalogData = (CComtradeAnalogData *)m_listAnalog.GetNext(pos_ch);
		pAnalogData->InsertNormalCyclePoints(dVolValue,dCurrentValue,m_pdSamRate[0],50.0f,nInsertPoints,m_nDataFileType);
	}

	//¸üÐÂ¿ª¹ØÁ¿Í¨µÀµÄÍ¨µÀÊý¾Ý
	POS pos_BinaryCh = m_listBinary.GetHeadPosition();
	CComtradeBinaryData *pBinaryData = NULL;

	while (pos_BinaryCh)
	{
		pBinaryData = (CComtradeBinaryData *)m_listBinary.GetNext(pos_BinaryCh);
		pBinaryData->InsertNormalCyclePoints(nInsertPoints,m_nDataFileType);
	}
 
	//¸üÐÂµÚÒ»¸ö²ÉÑùÂÊµÄ×ÜµãÊý¼°¸üÐÂ×ÜµÄ²ÉÑùµãÊý
// 	m_pnDataPoints[0] += nInsertPoints;
	UpdateSmpRatesList();
 	m_nTotalPoints += nInsertPoints;
	CalMinMaxValue();//É¾³ýÖØÐÂ¼ÆËã×î´ó×îÐ¡Öµ
	return TRUE;
}


long CRcdComtradeFile::FindPointIndexByRelTime( double dTime  ,double *pdTime,long nSamAmount)
	{
		for (int nIndex = 0; nIndex < m_nSamAmount; nIndex++)
		{
		int nDataPoints = m_pnDataPoints[nIndex];
	}
	if(dTime < 0 )
			{
		return -1;
				}

	int nTimeDurIndex = -1;
	for (int nIndex = 0; nIndex < nSamAmount; nIndex++)
				{
		if (dTime < pdTime[nIndex])
				{
			nTimeDurIndex = nIndex;
			break;
				}
			}

	return nTimeDurIndex;
		}

void CRcdComtradeFile::UpdateSampleRaes(long nSamAmount,const double* pdSamRate,const long* pnDataPoints )
{
	if (m_pnDataPoints != NULL)
	{
		delete[] m_pnDataPoints;
		m_pnDataPoints = NULL;
	}

	if (m_pdSamRate != NULL)
	{
		delete[] m_pdSamRate;
		m_pdSamRate = NULL;
	}

	// ÁÙÊ±Êý×éÓÃÓÚ´æ´¢ºÏ²¢ºóµÄÊý¾Ý
	long* tempDataPoints = new long[nSamAmount];
	float* tempSamRate = new float[nSamAmount];

	int newIndex = 0;
	for (int i = 0; i < nSamAmount; ++i)
	{
		if (i > 0 && pdSamRate[i] == pdSamRate[i - 1])
		{
			// Èç¹û²ÉÑùÂÊÏàÍ¬£¬ÀÛ¼ÓÊý¾Ýµã
			tempDataPoints[newIndex - 1] += pnDataPoints[i];
		}
		else
		{
			// ¸´ÖÆ²ÉÑùÂÊºÍÊý¾Ýµã
			tempDataPoints[newIndex] = pnDataPoints[i];
			tempSamRate[newIndex] = pdSamRate[i];
			++newIndex;
		}
	}

	// ¸üÐÂºóµÄ²ÉÑùµãÊý£¨¶ÎÊý£©
	m_nSamAmount = newIndex;

	//2025-3-18  ÓÅ»¯²»ÁíÍâ·ÖÅäÄÚ´æ£¬Ö±½Ó·ÖÅä¸ø³ÉÔ±±äÁ¿
	m_pnDataPoints = tempDataPoints;
	m_pdSamRate = tempSamRate;
	for (int i = 0; i < m_nSamAmount; ++i)
 	{ 
#ifdef _PSX_IDE_QT_ 
		//µ÷ÊÔÓÃ
		qDebug()<< "µÚ"<< i <<"¶Î²ÉÑùÂÊ"<<m_pdSamRate[i];
		qDebug()<< "µÚ"<< i <<"¶Î²ÉÑùµãÊý"<<m_pnDataPoints[i];
#else
//  		CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("µÚ%d¶Î²ÉÑùÂÊ:%.3f"), i, m_pdSamRate[i]);
//  		CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("µÚ%d¶Î²ÉÑùµãÊý:%d"), i, m_pnDataPoints[i])	;
#endif
	}

// 	// ÖØÐÂ·ÖÅäÊý×é´óÐ¡ÒÔÊÊÓ¦ºÏ²¢ºóµÄ²ÉÑù¶ÎÊý
// 	m_pnDataPoints = new long[m_nSamAmount];
// 	m_pdSamRate = new float[m_nSamAmount];
// 
// 	// ¸´ÖÆºÏ²¢ºóµÄÊý¾Ýµ½×îÖÕÊý×é
// 	for (int i = 0; i < m_nSamAmount; ++i)
// 	{
// 		m_pnDataPoints[i] = tempDataPoints[i];
// 		m_pdSamRate[i] = tempSamRate[i];
// 
// 		//µ÷ÊÔÓÃ
// 		// 		CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("µÚ%d¶Î²ÉÑùÂÊ:%.3f"), i, m_pdSamRate[i]);
// 		// 		CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("µÚ%d¶Î²ÉÑùµãÊý:%d"), i, m_pnDataPoints[i]	
// 	}
// 
// 	// ÊÍ·ÅÁÙÊ±Êý×é
// 	if (!tempDataPoints)
// 	{
// 		delete[]  tempDataPoints;
// 		tempDataPoints = NULL;
// 	}
// 	if (!tempSamRate)
// 	{
// 		delete[]  tempSamRate;
// 		tempSamRate = NULL;
// 	}

}

void CRcdComtradeFile::SaveAsciiDatDataFile(const CString& strFilePath)
{
	long nIndex = 0;

	long nSteps = 20;
	long nStepPoints = m_nTotalPoints / nSteps;
	long nStep = 0;

	if (nStepPoints > 65536)
	{
		nStepPoints = 65536;
		nStepPoints = m_nTotalPoints / nSteps;
		nSteps = m_nTotalPoints / nStepPoints + 1;
	}

	if (nStepPoints * nSteps < m_nTotalPoints)
	{
		nSteps++;
	}

	long nStepIndex = 0;

	FILE* pFile = NULL;
	CString strDatFilePath;
	//strDatFilePath.Format(_T("%s.%s"),strFilePath,g_pszKeyDat);
	strDatFilePath = strFilePath;

	CString strTempKey = CString(g_pszKeyDat);
	strDatFilePath = ChangeFilePostfix(strFilePath, _T("Apdat"));

	CString strTemp;
	char pszDatFilePath[MAX_PATH];
	CString_to_char(strDatFilePath, pszDatFilePath);
	pFile = fopen(pszDatFilePath, "wb");
	long nTmpValue = 0;
	CComtradeDataBase* pObj = NULL;
	POS pos = NULL;
	long nBinaryIndex = 0;//¿ª¹ØÍ¨µÀË÷Òý
	WORD wBinaryValue = 0;
	CString strTmp;
	unsigned short unCurrentData = 0;

	if (pFile == NULL)
		return;

	DWORD dwIndex = 1;
	DWORD dwmTimestamp = 0xFFFFFFFF; //²»¼ÆËãÊ±±êÁË£¬ÒòÎª²ÉÑùÂÊºÍ¸÷¸ö²ÉÑùÂÊÏÂµÄµãÊý¶¼ÓÐ
	nIndex = 0;
	unsigned short unCurBinaryData = 0;//zhouhj ÒòÎªÖ»ÓÐµÚÒ»¸ö¿ª¹ØÁ¿Í¨µÀ¼ÇÂ¼ÁËÍêÕûµÄÁ¬Ðø16¸öÍ¨µÀµÄ×´Ì¬Öµ£¬Ðè½«Æä¼ÇÂ¼
	double dDou = 0.0f;
	/////// ±£´æÊý¾Ý	
	//		if (m_nBufLength1 > 0)
	for (nIndex = 0; nIndex < m_nTotalPoints; nIndex += m_nSaveGap)
	{
		dwmTimestamp = GetCurPointTimeStamp(nIndex);
		// 		fwrite(&dwIndex, 4, 1, pFile);
		// 		fwrite(&dwmTimestamp, 4, 1, pFile);
		fprintf(pFile, "%lu,%lu", dwIndex, dwmTimestamp);
		nBinaryIndex = 0;
		wBinaryValue = 0;
		unCurBinaryData = 0;
		pos = GetHeadPosition();

		while (pos != NULL)
		{
			pObj = (CComtradeDataBase*)GetNext(pos);

			if (pObj->GetClassID() == GLOBALCLASSID_CCOMTRADERATEDATA)
			{
				continue;
			}

			long* pBuffer = (long *)pObj->GetBuffer();
			unsigned short* pBinaryBuffer = pObj->GetBuffer();

			//ÓÉÓÚ¿ª³öÁ¿Í¨µÀÊÇ¹ÒÔØbuffer£¬ºó¼¸ÌõÍ¨µÀÃ»ÓÐÊµ¼Ê»º´æÇø,µ¼ÖÂÔ½½çÖÐ¶Ï
			if (pObj->m_nTotalPoints <= 0)
			{
				continue;
			}

			nTmpValue = *(pBuffer + nIndex);

			if (pObj->IsAnalogData())
			{
				CComtradeAnalogData *p = (CComtradeAnalogData*)pObj;
				nTmpValue = p->GetAttachBuffer_long(m_nDataFileType, nIndex);
				p->CalValue(nTmpValue, dDou);
				//strTmp.Format(_T("%ld\r\n"),nTmpValue);

				//fprintf(pFile, ",%.3f", dDou);
				fprintf(pFile, ",%n", nTmpValue);
			}
			else // ÒòÎªÁ´±íÖÐÊÇ°´ÕÕÏÈÄ£Äâºó¿ª¹ØµÄË³Ðò·ÅÖÃ
			{
				unCurrentData = *(pBinaryBuffer + nIndex);

				for (int n = 0; n < 16; ++n)
				{
					int nBitValue = unCurrentData >> n & 0x01;
					fprintf(pFile, ",%d", nBitValue);
				}
				nBinaryIndex++;
			}


		}

		nStepIndex++;

		if (nStepIndex >= nStepPoints)
		{
			nStepIndex = 0;
			////g_theRecordApp.FireSysOptrMsg(MR1200_SYSOPTR_SAVE_RECORDFILE, 0, MAKELONG(nStep, nSteps));
			nStep++;
		}

		dwIndex++;

		fprintf(pFile, "\n");
	}
	//////////////////////////

	fclose(pFile);
	pFile = NULL;
}

void CRcdComtradeFile::SaveBinaryDatDataFile(const CString& strFilePath)
{
	long nIndex = 0;

	long nSteps = 20;
	long nStepPoints = m_nTotalPoints / nSteps;
	long nStep = 0;

	if (nStepPoints > 65536)
	{
		nStepPoints = 65536;
		nStepPoints = m_nTotalPoints / nSteps;
		nSteps = m_nTotalPoints / nStepPoints + 1;
	}

	if (nStepPoints * nSteps < m_nTotalPoints)
	{
		nSteps++;
	}

	long nStepIndex = 0;

	FILE* pFile = NULL;
	CString strDatFilePath;
	//strDatFilePath.Format(_T("%s.%s"),strFilePath,g_pszKeyDat);
	strDatFilePath = strFilePath;

	CString strTempKey = CString(g_pszKeyDat);
	strDatFilePath = ChangeFilePostfix(strFilePath, _T("Bpdat"));

	CString strTemp;
	char pszDatFilePath[MAX_PATH];
	CString_to_char(strDatFilePath, pszDatFilePath);
	pFile = fopen(pszDatFilePath, "wb");
	unsigned short unCurrentData = 0;
	CComtradeDataBase* pObj = NULL;
	POS pos = NULL;
	long nBinaryIndex = 0;//¿ª¹ØÍ¨µÀË÷Òý
	WORD wBinaryValue = 0;

	if (pFile == NULL)
		return;

	DWORD dwIndex = 1;
	DWORD dwmTimestamp = 0xFFFFFFFF; //²»¼ÆËãÊ±±êÁË£¬ÒòÎª²ÉÑùÂÊºÍ¸÷¸ö²ÉÑùÂÊÏÂµÄµãÊý¶¼ÓÐ
	nIndex = 0;
	unsigned short unCurBinaryData = 0;//zhouhj ÒòÎªÖ»ÓÐµÚÒ»¸ö¿ª¹ØÁ¿Í¨µÀ¼ÇÂ¼ÁËÍêÕûµÄÁ¬Ðø16¸öÍ¨µÀµÄ×´Ì¬Öµ£¬Ðè½«Æä¼ÇÂ¼
	double dDou = 0.0f;
	/////// ±£´æÊý¾Ý	
	//		if (m_nBufLength1 > 0)
	for (nIndex = 0; nIndex < m_nTotalPoints; nIndex += m_nSaveGap)
	{
		dwmTimestamp = GetCurPointTimeStamp(nIndex);
		// 		fwrite(&dwIndex,4,1,pFile);
		// 		fwrite(&dwmTimestamp,4,1,pFile);
		fprintf(pFile, "%lu,%lu", dwIndex, dwmTimestamp);
		nBinaryIndex = 0;
		wBinaryValue = 0;
		unCurBinaryData = 0;
		pos = GetHeadPosition();

		while (pos != NULL)
		{
			pObj = (CComtradeDataBase*)GetNext(pos);

			if (pObj->GetClassID() == GLOBALCLASSID_CCOMTRADERATEDATA)
			{
				continue;
			}

			unsigned short* pBuffer = pObj->GetBuffer();

			//ÓÉÓÚ¿ª³öÁ¿Í¨µÀÊÇ¹ÒÔØbuffer£¬ºó¼¸ÌõÍ¨µÀÃ»ÓÐÊµ¼Ê»º´æÇø,µ¼ÖÂÔ½½çÖÐ¶Ï
			if (pObj->m_nTotalPoints <= 0)
			{
				continue;
			}

			unCurrentData = *(pBuffer + nIndex);

			if (pObj->IsAnalogData())
			{
				CComtradeAnalogData *p = (CComtradeAnalogData *)pObj;
				if (unCurrentData == 0x8000)//0x8000 ±£Áô
				{
					unCurrentData = 0x8001;
				}

				p->CalValue(unCurrentData, dDou);
				fprintf(pFile, ",%lu", unCurrentData);//¼ÆËãÇ°Êý¾Ý
// 				fprintf(pFile, ",%.3f", dDou);//¼ÆËãºóÊý¾Ý
			}
			else // ÒòÎªÁ´±íÖÐÊÇ°´ÕÕÏÈÄ£Äâºó¿ª¹ØµÄË³Ðò·ÅÖÃ
			{
				unCurrentData = *(pBuffer + nIndex);

				for (int n = 0; n < 16; ++n)
				{
					int nBitValue = unCurrentData >> n & 0x01;
					fprintf(pFile, ",%d", nBitValue);
				}
				nBinaryIndex++;

			}
		}

		nStepIndex++;

		if (nStepIndex >= nStepPoints)
		{
			nStepIndex = 0;
			////g_theRecordApp.FireSysOptrMsg(MR1200_SYSOPTR_SAVE_RECORDFILE, 0, MAKELONG(nStep, nSteps));
			nStep++;
		}

		dwIndex++;
		fprintf(pFile, "\n", unCurrentData);
	}
	fclose(pFile);
	pFile = NULL;


}

int CRcdComtradeFile::FindPointIndexByDataPoints( int nPos, long *pdDataPoints, int &nDistance)
{
	if (pdDataPoints == NULL) 
			{
		return -1;  
		}

	int nDataPointIndex = 0;
	int nPreviousIndex = 0;
	for (int nIndex = 0; nIndex < m_nSamAmount; ++nIndex) 
	{
		if(nIndex == 0)
		{
			nDataPointIndex = pdDataPoints[nIndex] -1;//×ó±ÕÓÒ¿ª
		}
		else
		{
			nDataPointIndex += pdDataPoints[nIndex];
		}
		if (nPos < nDataPointIndex) 
		{
			nDistance = nPos - nPreviousIndex; // ÉèÖÃ²îÖµ
			return nIndex;  // ·µ»Ø¶ÎµÄË÷Òý
		}

		nPreviousIndex = nDataPointIndex;
	}
	return -1;  // Èç¹ûnPos³¬³öËùÓÐ¶Î£¬Ôò·µ»Ø-1
}

void CRcdComtradeFile::UpdateSamDateAfterDelete( int nBeginPos, int nEndPos )
{
	int nBeginDistance = 0 , nEndDistance = 0;

	int nBeginIndex = FindPointIndexByDataPoints(nBeginPos, m_pnDataPoints, nBeginDistance);
	int nEndIndex = FindPointIndexByDataPoints(nEndPos, m_pnDataPoints, nEndDistance);
	int nDeleteLength = nEndPos - nBeginPos;
	if(nBeginIndex == -1 || nEndIndex == -1 || nEndIndex < nBeginIndex)
	{
		return;
	}

	//Èç¹ûÉ¾³ýµÄµã,ÆðÊ¼ºÍ½áÊøÎ»ÖÃÔÚÍ¬Ò»¸ö²ÉÑùÂÊÏÂ£¬ÔòÖ»ÐèÒª¸Ä±ä¸Ã²ÉÑùÂÊÏÂµÄ×ÜµãÊý¼´¿É
	if (nBeginIndex == nEndIndex)
	{
		//¸üÐÂµ±Ç°¶Î²ÉÑùµãÊý
		m_pnDataPoints[nBeginIndex] -= nDeleteLength;
		UpdateSmpRatesList();
		return;
	}

	int nDeleteSegNum = nEndIndex - nBeginIndex;
	int nNewSamAmount = m_nSamAmount - nDeleteSegNum; // °üº¬±ß½çµÄÉ¾³ý
	float *pdNewSamRate = NULL;
	long *pnNewDataPoints  = NULL;

	if ((nEndPos+1) == m_nTotalPoints)//Èç¹û½áÊøµãÎ»ÖÃÔÚ²¨ÐÎ×îºó,Ôò±£ÁôÆðÊ¼Î»ÖÃµÄµã,É¾³ý½áÊøÎ»ÖÃµã
	{
		pdNewSamRate = new float[nNewSamAmount];
		pnNewDataPoints  = new long[nNewSamAmount];

		for (int nIndex = 0; nIndex < m_nSamAmount; nIndex++)
		{
			if (nIndex < nBeginIndex)//Ð¡ÓÚÆðÊ¼²ÉÑùÂÊÊ±£¬Ö±½Ó¿½±´
			{
				pnNewDataPoints[nIndex] = m_pnDataPoints[nIndex];
				pdNewSamRate[nIndex] = m_pdSamRate[nIndex];
			}
			else
			{
				pnNewDataPoints[nIndex] = (nBeginDistance + 1);
				pdNewSamRate[nIndex] = m_pdSamRate[nIndex];
				break;
			}
		}
	} 
	else//·ñÔòÉ¾³ýÆðÊ¼Î»ÖÃµÄµã,±£Áô½áÊøÎ»ÖÃµã
			{
		if (nBeginDistance != 0)//Èç¹ûÉ¾³ýµÄÆðÊ¼Î»ÖÃ,²»ÊÇ¸Ã²ÉÑùÂÊÏÂµÄµÚÒ»¸öµã,Ôò²ÉÑùÂÊÊýÁ¿»á¶àÒ»¸ö
				{
			nNewSamAmount++;
			pdNewSamRate = new float[nNewSamAmount];
		pnNewDataPoints  = new long[nNewSamAmount];
				}

		int nNewIndex = 0; // ÐÂÊý×éµÄË÷Òý

		for (int nIndex = 0; nIndex < m_nSamAmount; nIndex++)
		{
			if ((nIndex < nBeginIndex) || (nIndex > nEndIndex))//Ð¡ÓÚÆðÊ¼²ÉÑùÂÊÊ±£¬Ö±½Ó¿½±´
				{
				pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex];
					pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
					nNewIndex++;
				}
			else if (nIndex == nBeginIndex)//µÈÓÚÆðÊ¼²ÉÑùÂÊÊ¹ÓÃÆðÊ¼Î»ÖÃ
			{
				if (nBeginDistance != 0)
				{
					pnNewDataPoints[nNewIndex] = nBeginDistance;
					pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
					nNewIndex++;
				}
			}
			else if (nIndex < nEndIndex)//´óÓÚÆðÊ¼²ÉÑùÂÊÐ¡ÓÚ½áÊø²ÉÑùÂÊ,Ìø¹ý
				{
					continue;
				}
			else if (nIndex == nEndIndex)//µÈÓÚ½áÊø²ÉÑùÂÊ,ÔòÖ±½Ó
				{
					pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex] - nEndDistance;
					pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
					nNewIndex++;
				}
			}
		}

	delete[] m_pnDataPoints;
	delete[] m_pdSamRate;
	// ¸üÐÂºóµÄ²ÉÑùµãÊý£¨¶ÎÊý£©
	m_nSamAmount = nNewSamAmount;

	// ÖØÐÂ·ÖÅäÊý×é´óÐ¡ÒÔÊÊÓ¦ºÏ²¢ºóµÄ²ÉÑù¶ÎÊý
	m_pnDataPoints = pnNewDataPoints;
	m_pdSamRate = pdNewSamRate;
	UpdateSmpRatesList();


// 	if(nBeginIndex != nEndIndex)//²»ÔÚÍ¬Ò»¸öÇø¼ä  //zhouhj 2025.3.15 ÓÅ»¯´¦ÀíÂß¼­
// 	{
// 		int nDeleteSegNum = nEndIndex - nBeginIndex;
// 		int nNewSamAmount = m_nSamAmount - nDeleteSegNum; // °üº¬±ß½çµÄÉ¾³ý
// 		float *pdNewSamRate = NULL;
// 		long *pnNewDataPoints = NULL;
// 
// 		pdNewSamRate = new float[nNewSamAmount];
// 		pnNewDataPoints = new long[nNewSamAmount];
// 
// 		int nNewIndex = 0; // ÐÂÊý×éµÄË÷Òý
// 
// 		for (int nIndex = 0; nIndex < m_nSamAmount; nIndex++)
// 		{
// 			if (nIndex < nBeginIndex)//Ð¡ÓÚÆðÊ¼²ÉÑùÂÊÊ±£¬Ö±½Ó¿½±´
// 			{
// 				pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex];
// 				pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
// 				nNewIndex++;
// 				continue;
// 			}
// 			else if (nIndex == nBeginIndex)//µÈÓÚÆðÊ¼²ÉÑùÂÊÊ¹ÓÃÆðÊ¼Î»ÖÃ
// 			{
// 				pnNewDataPoints[nNewIndex] = nBeginDistance + 1;
// 				pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
// 				nNewIndex++;
// 				continue;
// 			}
// 			else if (nIndex<nEndIndex)//´óÓÚÆðÊ¼²ÉÑùÂÊÐ¡ÓÚ½áÊø²ÉÑùÂÊ,Ìø¹ý
// 			{
// 				continue;
// 			}
// 			else if (nIndex == nEndIndex)//µÈÓÚ½áÊø²ÉÑùÂÊ,ÔòÖ±½Ó
// 			{
// 				pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex] - nEndDistance;
// 				pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
// 				nNewIndex++;
// 				continue;
// 			}
// 
// 			pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex];
// 			pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
// 			nNewIndex++;
// 
// // 			if (nIndex < nBeginIndex || nIndex > nEndIndex)
// // 			{
// // 				pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex];
// // 				pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
// // 				nNewIndex++;
// // 			}
// // 			else if (nIndex == nBeginIndex)
// // 			{
// // 				if (nBeginDistance == 0)
// // 				{
// // 					continue;
// // 				}
// // 				else
// // 				{
// // 					pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex] - nBeginDistance;
// // 					pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
// // 					nNewIndex++;
// // 				}
// // 
// // 			}
// // 			else if (nIndex == nEndIndex)
// // 			{
// // 				if (nEndDistance == 0)
// // 				{
// // 					nNewIndex -= 1;
// // 					continue;
// // 				}
// // 				else
// // 				{
// // 					pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex] - nEndDistance;
// // 					pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
// // 					nNewIndex++;
// // 				}
// // 			}
// 		}
// 
// 		delete[] m_pnDataPoints;
// 		delete[] m_pdSamRate;
// 		// ¸üÐÂºóµÄ²ÉÑùµãÊý£¨¶ÎÊý£©
// 		m_nSamAmount = nNewSamAmount;
// 
// 		// ÖØÐÂ·ÖÅäÊý×é´óÐ¡ÒÔÊÊÓ¦ºÏ²¢ºóµÄ²ÉÑù¶ÎÊý
// 		m_pnDataPoints = pnNewDataPoints;
// 		m_pdSamRate = pdNewSamRate;
// 		UpdateSmpRatesList();
// //		UpdateSampleRaes(nNewSamAmount, pdNewSamRate, pnNewDataPoints);
// 
// // 		delete[] pdNewSamRate;
// // 		pdNewSamRate = NULL;
// // 		delete[] pnNewDataPoints;
// // 		pnNewDataPoints = NULL;
// 	}
// 	else
// 	{
// 		//¸üÐÂµ±Ç°¶Î²ÉÑùµãÊý
// 		m_pnDataPoints[nBeginIndex] -= nDeleteLength;
// 	}
}

void CRcdComtradeFile::UpdateSamDateAfterInsert( int nBeginPos, int nEndPos, int nInsertPos, int nCycNum )
{
	int nBeginDistance = 0, nEndDistance = 0, nInsertDistance = 0;

	int nBeginIndex = FindPointIndexByDataPoints(nBeginPos, m_pnDataPoints, nBeginDistance);
	int nEndIndex = FindPointIndexByDataPoints(nEndPos, m_pnDataPoints, nEndDistance);
	int nInsertIndex = FindPointIndexByDataPoints(nInsertPos, m_pnDataPoints, nInsertDistance);


	if (nBeginIndex == -1 || nEndIndex == -1 || nInsertIndex == -1 || nEndIndex < nBeginIndex)
	{
		return;
	}

	if(nBeginIndex == nEndIndex)//ÔÚÍ¬Ò»¸öÇø¼äÖ±½ÓÀ©³äµãÊý
				{
		m_pnDataPoints[nBeginIndex] += (nEndPos - nBeginPos) * nCycNum;
		return;
				}

	int nSamAmount = 0;
	int nInsertSegNum = nEndIndex - nBeginIndex + 1;
	int nNewSamAmount = m_nSamAmount + nInsertSegNum * nCycNum + 1;//// ÓÐ¸²¸ÇÊ±ÊÇ¶ÔµÄ£¬µ«ÊÇ½Ø¶ÏµÄÊ±ºòÓ¦¸Ã+1
	float *pdNewSamRate = new float[nNewSamAmount];
		long *pnNewDataPoints = new long[nNewSamAmount];
	int nNewIndex = 0; // ÐÂÊý×éµÄË÷Òý

		// ¸´ÖÆÔ­Êý×éµÄÇ°°ë²¿·Ö
		for (int nIndex = 0; nIndex <= nInsertIndex; ++nIndex)
		{
			if (nIndex == nInsertIndex)//²åÈëÆðµãµÄÇ°²¿·Ö
		{
				if (nInsertDistance == 0)  // ²åÈë¶ÎÎªÕû¶Î£¬Ìø¹ý¸´ÖÆ²åÈëµã
				{
					break;  // Ö±½ÓÍË³öÑ­»·£¬²»ÔÙ¸´ÖÆ²åÈëµãµÄÄÚÈÝ
				}
				else
			{
				pnNewDataPoints[nNewIndex] = nInsertDistance;
				}

				pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
			}
			else
			{
				pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
				pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex];
			}
		nNewIndex++;			
			}

	//²åÈë²¿·Ö
		for (int nCycIndex = 0; nCycIndex < nCycNum; nCycIndex++)
		{
		for (int nIndex = nBeginIndex; nIndex <= nEndIndex; ++nIndex)
			{
			if (nIndex == nBeginIndex)
			{
				pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex] - nBeginDistance;
			}
			else if (nIndex == nEndIndex)
			{
				if (nEndDistance == 0) 
					break;
				pnNewDataPoints[nNewIndex] = nEndDistance;
			}
			else
			{
				pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex];
		}

			pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];

			// ½øÐÐºÏ²¢¼ì²é£¨µ±Ç° `pdNewSamRate` ÊÇ·ñºÍÇ°Ò»¶ÎÏàÍ¬£©
			if (nNewIndex > 0 && pdNewSamRate[nNewIndex] == pdNewSamRate[nNewIndex - 1])
		{
				pnNewDataPoints[nNewIndex - 1] += pnNewDataPoints[nNewIndex];  // ºÏ²¢²ÉÑùµãÊý
		}
		else
		{
				nNewIndex++;  // Ö»ÓÐÔÚ²»ºÏ²¢Ê±²ÅµÝÔö
			}

		}
	}


	//ºó°ë²¿·Ö
// 	int nLastIndex = nInsertIndex + nInsertSegNum * nCycNum + 1;
// 	if (bCover) { nInsertIndex += 1; }

		for (int nIndex = nInsertIndex; nIndex < m_nSamAmount; ++nIndex)
		{

		if (nIndex == nInsertIndex)
			{
				pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
			pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex] - nInsertDistance;
			}
			else
			{
					pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
						pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex];
					}

		if (nNewIndex > 0 && pdNewSamRate[nNewIndex] == pdNewSamRate[nNewIndex - 1])
					{
			pnNewDataPoints[nNewIndex - 1] += pnNewDataPoints[nNewIndex];  // ºÏ²¢²ÉÑùµãÊý
					}
		else 
					{
			nNewIndex++;  // Ö»ÓÐÔÚ²»ºÏ²¢Ê±²ÅµÝÔö
					}
				}
		m_nSamAmount = nNewIndex;
 		for (int n = 0; n < nNewSamAmount; n++)
				{
//  			CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("ÍêÕû%d:ÂÊ£º%.3f"), n, pdNewSamRate[n]);
//  			CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("ÍêÕû%d:µãÊý£º%d"), n, pnNewDataPoints[n]);
#ifdef _PSX_IDE_QT_ 

			qDebug()<< n << ":ÂÊ"<<pdNewSamRate[n];
			qDebug()<< n << ":µãÊý"<< pnNewDataPoints[n];
#endif
				}

		delete []m_pnDataPoints;
		delete []m_pdSamRate;

		m_pnDataPoints = pnNewDataPoints;
		m_pdSamRate = pdNewSamRate;

		UpdateSmpRatesList();

	//2025-3-18 wuxinyi ÓÅ»¯
//************************************************************************/
// 	if (nBeginIndex != nEndIndex)//²»ÔÚÍ¬Ò»¸öÇø¼ä
// 	{
		//ÐèÒªµÄ¶ÎÊý
// 		int nInsertSegNum = nEndIndex - nBeginIndex + 1;
// 		double *pdInsertSamRate = new double[nInsertSegNum];
// 		long *pnInsertDataPoints = new long[nInsertSegNum];
// 		int nNewIndex = 0; // ÐÂÊý×éµÄË÷Òý
// 
// 		for (int nIndex = nBeginIndex; nIndex <= nEndIndex; nIndex++)
// 		{
// 			// 			if(nIndex >= nBeginIndex && nIndex <= nEndIndex)
// 			{
// 				if (nIndex == nBeginIndex)
// 				{
// 					if (nBeginDistance == 0)//µ±²åÈëµãÊýÎª0Ê±£¬ÒâÎ¶×ÅµÚnNewIndex³¤¶ÈÎªÕû¶Î
// 					{
// 						pnInsertDataPoints[nNewIndex] = m_pnDataPoints[nIndex];
// 					}
// 					else
// 					{
// 						pnInsertDataPoints[nNewIndex] = m_pnDataPoints[nIndex] - nBeginDistance;
// 					}
// 
// 				}
// 				else if (nIndex == nEndIndex)
// 				{
// 					if (nEndDistance == 0)
// 					{
// 						break;
// 					}
// 
// 					pnInsertDataPoints[nNewIndex] = nEndDistance;
// 				}
// 				else
// 				{
// 					pnInsertDataPoints[nNewIndex] = m_pnDataPoints[nIndex];
// 
// 				}
// 			}
// 					pdInsertSamRate[nNewIndex] = m_pdSamRate[nIndex];
// 					nNewIndex++;
// 				}
// 
// 		//µ÷ÊÔÊ¹ÓÃ
// 		// 		for (int n = 0; n < nInsertSegNum; n++)
// 		// 		{
// 		// 			CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("²åÈë%d:ÂÊ£º%.3f"), n, pdInsertSamRate[n]);
// 		// 			CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("²åÈë%d:µãÊý£º%d"), n, pnInsertDataPoints[n]);
// 		// 		}
// 
// 		//¸üÐÂÎªÒ»¸öÕûÌå
// 		int nNewSamAmount = m_nSamAmount + nInsertSegNum * nCycNum/* +1*/;
// 		double *pdNewSamRate = new double[nNewSamAmount];
// 		long *pnNewDataPoints = new long[nNewSamAmount];
// 		nNewIndex = 0; // ÐÂÊý×éµÄË÷Òý
// 		bool bCover = false;
// 
// 		// ¸´ÖÆÔ­Êý×éµÄÇ°°ë²¿·Ö
// 		for (int nIndex = 0; nIndex <= nInsertIndex; ++nIndex)
// 		{
// 			if (nIndex == nInsertIndex)//²åÈëÆðµãµÄÇ°²¿·Ö
// 		{
// 				if (nInsertDistance == 0)  // ²åÈë¶ÎÎªÕû¶Î£¬Ìø¹ý¸´ÖÆ²åÈëµã
// 				{
// 					break;  // Ö±½ÓÍË³öÑ­»·£¬²»ÔÙ¸´ÖÆ²åÈëµãµÄÄÚÈÝ
// 				}
// 				else
// 				{
// 					pnNewDataPoints[nNewIndex] = nInsertDistance;
// 
// 					if (nInsertDistance == m_pnDataPoints[nInsertIndex])
// 					{
// 						//ÓÐÖØºÏ,×îºóÒ»¶ÎÎªÖ®ºóµÄ¶ÎÊý
// 						bCover = true;
// 					}
// 				}
// 
// 				pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
// 			}
// 			else
// 			{
// 				pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
// 				pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex];
// 			}
// 				nNewIndex++;
// 			}
// 
// 		// ²åÈëÐÂÊý×é
// 		for (int nCycIndex = 0; nCycIndex < nCycNum; nCycIndex++)
// 		{
// 			for (int nIndex = 0; nIndex < nInsertSegNum; ++nIndex)
// 			{
// 				pdNewSamRate[nNewIndex] = pdInsertSamRate[nIndex];
// 				pnNewDataPoints[nNewIndex] = pnInsertDataPoints[nIndex];
// 				nNewIndex++;
// 			}
// 		}
// 
// 		int nLastIndex = nInsertIndex + nInsertSegNum * nCycNum + 1;
// 
// 		if (bCover)
// 		{
// 			nInsertIndex += 1;
// 		}
// 		else
// 		{
// 			nNewSamAmount += 1;
// 		}
// 
// 
// 		for (int nIndex = nInsertIndex; nIndex < m_nSamAmount; ++nIndex)
// 		{
// 			if (bCover)
// 			{
// 				pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
// 				pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex];
// 			}
// 			else
// 			{
// 				if (nNewIndex == nLastIndex)
// 				{
// 					pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
// 					if (nInsertDistance == 0)
// 					{
// 						pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex];
// 					}
// 					else if (m_pnDataPoints[nIndex] == nInsertDistance)
// 					{
// 						continue;
// 					}
// 					else
// 					{
// 						pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex] - nInsertDistance;
// 					}
// 				}
// 				else
// 				{
// 					pdNewSamRate[nNewIndex] = m_pdSamRate[nIndex];
// 					pnNewDataPoints[nNewIndex] = m_pnDataPoints[nIndex];
// 				}
// 
// 			}
// 
// 			nNewIndex++;
// 		}
// 
// 		// 		for (int n = 0; n < nNewSamAmount; n++)
// 		// 		{
// 		// 			CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("%d:ÂÊ£º%.3f"), n, pdNewSamRate[n]);
// 		// 			CLogPrint::LogFormatString(XLOGLEVEL_ERROR, _T("%d:µãÊý£º%d"), n, pnNewDataPoints[n]);
// 		// 		}

// 		UpdateSampleRaes(nNewSamAmount, pdNewSamRate, pnNewDataPoints);

		// ÊÍ·ÅÄÚ´æ
// 		if (!pdInsertSamRate)
// 		{
// 			delete[] pdInsertSamRate;
// 			pdInsertSamRate = NULL;
// 		}
// 
// 		if (!pnInsertDataPoints)
// 		{
// 			delete[]  pnInsertDataPoints;
// 			pnInsertDataPoints = NULL;
// 		}

// 		if (!pdNewSamRate)
// 		{
// 			delete[]  pdNewSamRate;
// 			pdNewSamRate = NULL;
// 		}
// 
// 		if (!pnNewDataPoints)
// 		{
// 			delete[]  pnNewDataPoints;
// 			pnNewDataPoints = NULL;
// 		}

// 	}
// 	else
// 	{
// 		m_pnDataPoints[nBeginIndex] += (nEndPos - nBeginPos) * nCycNum;
// 	}

}

CComtradeBinaryData * CRcdComtradeFile::FindBinaryDataByChID( const CString &strID )
{
	POS pos = m_listBinary.GetHeadPosition();
	CComtradeBinaryData *pCurObj = NULL;
	CComtradeBinaryData *pBinaryChFind = NULL;

	while(pos)
	{
		pCurObj = (CComtradeBinaryData*)m_listBinary.GetNext(pos);

		if (pCurObj->m_strID == strID)
		{
			pBinaryChFind = pCurObj;
			break;
		}
	}
	return pBinaryChFind;
}

CComtradeBinaryData* CRcdComtradeFile::GetBinaryDataByIndex( long nIndex )
{
	return (CComtradeBinaryData*)m_listBinary.GetAtIndex(nIndex);
}

//////////////////////////////////////////////////////////////////////////
//
CRcdComtradeFileMngr* CRcdComtradeFileMngr::g_pCComtradeMngr = NULL;
long CRcdComtradeFileMngr::g_nComtradeMngrRef = 0;
const CString CRcdComtradeFileMngr::g_strComtradeFileFilter = _T("COMTRADE File(*.cfg)|*.cfg|COMTRADE File(*.dat)|*.dat||");

CRcdComtradeFileMngr::CRcdComtradeFileMngr()
{

}

CRcdComtradeFileMngr::~CRcdComtradeFileMngr()
{

}


CRcdComtradeFileMngr* CRcdComtradeFileMngr::Create()
{
	g_nComtradeMngrRef++;

	if (g_nComtradeMngrRef == 1)
	{
		g_pCComtradeMngr = new CRcdComtradeFileMngr();

	}

	// 	g_pCComtradeMngr->m_bCreateBuffer = bCreateBuffer;

	return g_pCComtradeMngr;
}

void CRcdComtradeFileMngr::Release()
{
	g_nComtradeMngrRef--;

	if (g_nComtradeMngrRef == 0)
	{
		delete g_pCComtradeMngr;
		g_pCComtradeMngr = NULL;
	}
}

BOOL CRcdComtradeFileMngr::PopOpenComtradeFile(CString &strFile)
{
	//xxy
#ifndef _PSX_IDE_QT_
	BOOL b = PopupOpenFileDialog(AfxGetMainWnd(), strFile, g_strComtradeFileFilter, _T("cfg"), _T("COMTRADE file"));
#endif

	return TRUE;
}

CRcdComtradeFile* CRcdComtradeFileMngr::OpenComtradeFile()
{
	//xxy
#ifndef _PSX_IDE_QT_
	CString strFile;

	if (! PopOpenComtradeFile(strFile))
	{
		return NULL;
	}
	else
	{
		return OpenComtradeFile(strFile);
	}
#endif
	return NULL;
}

CRcdComtradeFile* CRcdComtradeFileMngr::NewComtradeFile()
{
	CRcdComtradeFile *pFile = new CRcdComtradeFile(TRUE);
	g_pCComtradeMngr->AddNewChild(pFile);

	return pFile;
}

void CRcdComtradeFileMngr::AddNewComtradeFileChild(CRcdComtradeFile *pChild)
{
	g_pCComtradeMngr->AddNewChild(pChild);
}

CRcdComtradeFile* CRcdComtradeFileMngr::OpenComtradeFile(const CString &strFile)
{
	CRcdComtradeFile *pFile = (CRcdComtradeFile*)g_pCComtradeMngr->FindByID(strFile);

	if (pFile != NULL)
	{
		return pFile;
	}

	pFile = new CRcdComtradeFile(TRUE);
	pFile->ReadComtradeFile(strFile);
	g_pCComtradeMngr->AddNewChild(pFile);

	return pFile;
}

CRcdComtradeFile* CRcdComtradeFileMngr::FindComtradeFile(const CString &strFile)
{
	CRcdComtradeFile *pFile = (CRcdComtradeFile*)g_pCComtradeMngr->FindByID(strFile);

	return pFile;
}
CRcdComtradeFile* CRcdComtradeFileMngr::GetComtradeFile(long nIndex)
{
	if (g_pCComtradeMngr == NULL)
	{
		return NULL;
	}

	return (CRcdComtradeFile*)g_pCComtradeMngr->GetAtIndex(nIndex);
}

BOOL CRcdComtradeFileMngr::CloseComtradeFile(const CString &strFile)
{
	CRcdComtradeFile *pFile = (CRcdComtradeFile*)g_pCComtradeMngr->FindByPath(strFile);

	if (pFile == NULL)
	{
		return TRUE;
	}

	g_pCComtradeMngr->Delete(pFile);

	return TRUE;
}

BOOL CRcdComtradeFileMngr::CloseComtradeFile(CRcdComtradeFile *pComtradeFile)
{
	return g_pCComtradeMngr->Delete(pComtradeFile);
}

long CRcdComtradeFileMngr::GetComtradeFileCount()
{
	return g_pCComtradeMngr->GetCount();
}
void CRcdComtradeFileMngr::SaveThisXml( CString &strPath )
{
	CRcdComtradeFile *pFile = (CRcdComtradeFile*)g_pCComtradeMngr->FindByPath(strPath);

	if (pFile==NULL)
	{
		return;
	}

	CString strDatFilePath = ChangeFilePostfix(strPath, _T("xml"));
	pFile->SaveXmlFile(strDatFilePath, CComtradeFileXmlRWKeys::g_pXmlKeys);
}

CExBaseObject *CRcdComtradeFileMngr::FindByPath(CString strPath)
{
	POS pos = GetHeadPosition();

	while (pos)
	{
		CRcdComtradeFile *pObj = (CRcdComtradeFile *)GetNext(pos);
		if (pObj->m_strComtradeFile == strPath)
		{
			return pObj;
		}
	}
	return NULL;
}
